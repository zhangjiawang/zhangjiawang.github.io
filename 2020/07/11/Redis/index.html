<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Redis 教程 | Mr.Wantの博客</title><meta name="keywords" content="redis,缓存"><meta name="author" content="Mr.Want,zhangjiawang99@gmail.com"><meta name="copyright" content="Mr.Want"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Redis 教程Nosql 概述为什么要用 Nosql 1、最早的单机 Mysql 的年代   90年代，一个网站的访问量一般不会太大，单个数据库完全足够！ 大部分都是使用静态 html 网页，服务器根本没有压力 瓶颈如下：">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis 教程">
<meta property="og:url" content="https://zhangjiawang.github.io/2020/07/11/Redis/index.html">
<meta property="og:site_name" content="Mr.Wantの博客">
<meta property="og:description" content="Redis 教程Nosql 概述为什么要用 Nosql 1、最早的单机 Mysql 的年代   90年代，一个网站的访问量一般不会太大，单个数据库完全足够！ 大部分都是使用静态 html 网页，服务器根本没有压力 瓶颈如下：">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg">
<meta property="article:published_time" content="2020-07-11T11:26:39.000Z">
<meta property="article:modified_time" content="2023-07-22T08:10:00.865Z">
<meta property="article:author" content="Mr.Want">
<meta property="article:tag" content="redis">
<meta property="article:tag" content="缓存">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg"><link rel="shortcut icon" href="https://s2.loli.net/2023/07/22/JWMeyTlnwOEi9t7.png"><link rel="canonical" href="https://zhangjiawang.github.io/2020/07/11/Redis/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Mr.Want","link":"链接: ","source":"来源: Mr.Wantの博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis 教程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-22 16:10:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    document.addEventListener('pjax:complete', detectApple)})(window)</script><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2022/08/27/Xqxt6gBj3eZkYLs.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Mr.Wantの博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis 教程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-07-11T11:26:39.000Z" title="发表于 2020-07-11 19:26:39">2020-07-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-07-22T08:10:00.865Z" title="更新于 2023-07-22 16:10:00">2023-07-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/redis/">redis</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">18.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>75分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis 教程"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Redis-教程"><a href="#Redis-教程" class="headerlink" title="Redis 教程"></a>Redis 教程</h1><h1 id="Nosql-概述"><a href="#Nosql-概述" class="headerlink" title="Nosql 概述"></a>Nosql 概述</h1><h2 id="为什么要用-Nosql"><a href="#为什么要用-Nosql" class="headerlink" title="为什么要用 Nosql"></a>为什么要用 Nosql</h2><blockquote>
<p>1、最早的单机 Mysql 的年代</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/07/22/5plfXYLKhU7cRE8.jpg" alt="image-20200709105625636"></p>
<p>90年代，一个网站的访问量一般不会太大，单个数据库完全足够！</p>
<p>大部分都是使用静态 html 网页，服务器根本没有压力</p>
<p>瓶颈如下：</p>
<span id="more"></span>

<p>1、数据量太大，一个机器放不下</p>
<p>2、数据索引（B+Tree），一个机器内存也放不下</p>
<p>3、访问量太大（读写混合），一个服务器承受不了</p>
<blockquote>
<p>2、Memcached（缓存）+ MySQL + 垂直拆分（读写分离）</p>
</blockquote>
<p>网站 80% 的情况都是在读，每次都去查询数据库就很麻烦，所以使用缓存来保证效率</p>
<p>发展过程：优化数据库结构和索引 → 文件缓存（IO）→ Memcache（当时最热门的技术）</p>
<p><img src="https://s2.loli.net/2023/07/22/K4d92kVbiqtgDBr.jpg" alt="image-20200709110640230"></p>
<blockquote>
<p>3、分库分表 + 水平拆分 + 集群</p>
</blockquote>
<p>早些年 MyISAM：表锁，十分影响效率，高并发下会出现严重的锁问题</p>
<p>转战 InnoDB：行锁</p>
<p>使用分库分表解决写的压力</p>
<p><img src="https://s2.loli.net/2023/07/22/2qhOeDSNwIyljZF.jpg" alt="image-20200709112134405"></p>
<blockquote>
<p>4、如今的互联网架构模型</p>
</blockquote>
<p> MySQL 等关系型数据库已经不够用了，各种各样的数据（音乐、热榜、图片等）都存在 MySQL 的话，数据库表很大，压力爆表，效率自然低下</p>
<p><img src="https://s2.loli.net/2023/07/22/PWvbM7n9d8BwQrL.jpg" alt="image-20200709113811000"></p>
<blockquote>
<p>为什么要用 NoSQL</p>
</blockquote>
<p>用户的个人信息、社交网络、自理位置、用户日志等等爆发式增长！</p>
<p>这个时候就需要用 NoSQL 数据库，NoSQL 可以很好处理以上情况</p>
<h2 id="什么是-NoSQL"><a href="#什么是-NoSQL" class="headerlink" title="什么是 NoSQL"></a>什么是 NoSQL</h2><blockquote>
<p>NoSQL</p>
</blockquote>
<p>NoSQL &#x3D; Not Only Sql （不仅仅是sql）</p>
<p>泛指非关系型数据库，随着 web2.0 互联网的诞生，传统的关系型数据库很难应对，尤其是超大规模的高并发社区，暴露出来很多难以克服的问题。NoSQL 在当今大数据环境下发展十分迅速，Redis 是发展最快，当下必须要掌握的技术</p>
<p>很多的数据类型用户的个人信息、社交网络、自理位置、用户日志这些数据不需要固定格式，不需要多元的操作就可以横向扩展。</p>
<blockquote>
<p>NoSQL 特点</p>
</blockquote>
<p>1、方便扩展（数据之间没有关系）</p>
<p>2、大数据量高性能（Redis 一秒写 8 万次，一秒读取 11 万次，缓存记录集，性能高）</p>
<p>3、多种多样的数据类型（不需要事先设计数据库，随取随用）</p>
<p>4、传统的 RDBMS 和 NoSQL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">传统的 RDBMS</span><br><span class="line">- 结构化组织</span><br><span class="line">- SQL</span><br><span class="line">- 数据和关系存在单独的表中 row clo</span><br><span class="line">- 多元操作</span><br><span class="line">- 严格的一致性</span><br><span class="line">- 事务</span><br><span class="line">- …………</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NoSQL</span><br><span class="line">- 不仅仅是数据</span><br><span class="line">- 没有固定的查询语言</span><br><span class="line">- 键值对存储、列存储、文档存储、图形数据库（社交关系）</span><br><span class="line">- 最终一致性</span><br><span class="line">- CAP 定理和 BASE </span><br><span class="line">- 高性能，高可用，高可扩展</span><br><span class="line">- …………</span><br></pre></td></tr></table></figure>

<blockquote>
<p>了解：3V+3高</p>
</blockquote>
<p>大数据时代的3V：</p>
<ol>
<li>海量数据</li>
<li>多样</li>
<li>实时</li>
</ol>
<p>大数据时代的3高：</p>
<ol>
<li>高并发</li>
<li>高可扩</li>
<li>高性能</li>
</ol>
<blockquote>
<p>大厂的架构 - 商品</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1、商品的基本信息（名称、价格、商家信息）</span></span><br><span class="line">	关系型数据库</span><br><span class="line">	- MySQL</span><br><span class="line">	- Oracle</span><br><span class="line">	</span><br><span class="line"><span class="comment"># 2、商品的描述、评论</span></span><br><span class="line">	文档型数据库</span><br><span class="line">	- MongoDB</span><br><span class="line">	</span><br><span class="line"><span class="comment"># 3、图片</span></span><br><span class="line">	分布式文件系统</span><br><span class="line">	- FastDFS</span><br><span class="line">	- TFS（淘宝）</span><br><span class="line">	- GFS（Google）</span><br><span class="line">	- Hadoop</span><br><span class="line">	- oss（阿里云）</span><br><span class="line">	</span><br><span class="line"><span class="comment"># 4、商品的关键字</span></span><br><span class="line">	搜索引擎</span><br><span class="line">	- solr elasticsearch</span><br><span class="line">	- Isearch</span><br><span class="line">	</span><br><span class="line"><span class="comment"># 5、热门的波段信息</span></span><br><span class="line">	内存数据路</span><br><span class="line">	- redis</span><br><span class="line">	- Memcache</span><br></pre></td></tr></table></figure>

<h2 id="Nosql-的四大分类"><a href="#Nosql-的四大分类" class="headerlink" title="Nosql 的四大分类"></a>Nosql 的四大分类</h2><p><strong>KV 键值对</strong></p>
<ul>
<li>新浪：Redis</li>
<li>美团：Redis + Tair</li>
<li>阿里、百度：Redis + Memcache</li>
</ul>
<p><strong>文档型数据库</strong></p>
<ul>
<li>MongoDB<ul>
<li>MongoDB 是一个基于分布式文件存储的数据库，C++ 编写</li>
<li>主要用来处理大量的文档</li>
<li>MongoDB 是一个介于关系型数据库和非关系型数据库中间的产品，MongoDB 是非关系型数据库中功能最丰富，最像关系型数据库的</li>
<li>CouchDB</li>
</ul>
</li>
</ul>
<p><strong>列存储数据库</strong></p>
<ul>
<li>HBase</li>
<li>分布式文件系统</li>
</ul>
<p><strong>图关系数据库（不是存图形，存的是关系，比如社交网络、广告推荐）</strong></p>
<p><img src="https://s2.loli.net/2023/07/22/QU1ried4y2JA7ml.jpg" alt="myfriends"></p>
<ul>
<li>Neo4j、InfoGrid</li>
</ul>
<blockquote>
<p>四者对比</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/07/22/cNdj4CAVvE52rom.jpg" alt="image-20200709183241350"></p>
<h1 id="Redis-入门"><a href="#Redis-入门" class="headerlink" title="Redis 入门"></a>Redis 入门</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><blockquote>
<p>Redis 是什么？</p>
</blockquote>
<p>Redis（<span style='color: red'>Re</span>mote <span style='color: red'>Di</span>ctionary <span style='color: red'>S</span>erver )，即远程字典服务。是一个开源的使用ANSI <a target="_blank" rel="noopener" href="https://baike.baidu.com/item/C%E8%AF%AD%E8%A8%80">C语言</a>编写、支持网络、可基于内存亦可持久化的日志型、Key-Value<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%BA%93/103728">数据库</a>，并提供多种语言的API</p>
<p>与 memcached 一样，为了保证效率，数据都是缓存在内存中。区别的是 redis 会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并且在此基础上实现了master-slave (主从)同步。</p>
<p>免费和开源！当下最热门的 NoSQL 技术之一，也被人们成为结构化数据库</p>
<blockquote>
<p>Redis 能干嘛？</p>
</blockquote>
<p>1、内存存储、持久化（rdb、aof）</p>
<p>2、效率高，可以用于高速缓存</p>
<p>3、发布订阅系统</p>
<p>4、地图信息分析</p>
<p>5、计时器、计数器（浏览量）</p>
<p>6、…………</p>
<blockquote>
<p>Redis 特性</p>
</blockquote>
<p>1、多样的数据类型</p>
<p>2、持久化</p>
<p>3、集群、事务</p>
<p>4、…………</p>
<blockquote>
<p><span style='color: red'>Redis 推荐在 Linux 服务器上搭建</span></p>
</blockquote>
<p>官网：<a target="_blank" rel="noopener" href="https://redis.io/">https://redis.io/</a></p>
<p>中文网：<a target="_blank" rel="noopener" href="http://redis.cn/">http://redis.cn/</a></p>
<p>下载地址：通过官网下载即可</p>
<p><img src="https://s2.loli.net/2023/07/22/WjdciLbfFh5PmEt.jpg" alt="image-20200709184914345"></p>
<p>注意：Windows 在 GitHub 上下载（已停更）</p>
<h2 id="Linux-安装"><a href="#Linux-安装" class="headerlink" title="Linux 安装"></a>Linux 安装</h2><p>1、下载安装包</p>
<p>2、解压安装包</p>
<p><img src="https://s2.loli.net/2023/07/22/G86h9UwYuJRVS1p.jpg" alt="image-20200709190925080"></p>
<p>3、进入解压后的文件夹，可以看到配置文件</p>
<img src="https://s2.loli.net/2023/07/22/bFQlXxWnVmY4s8M.jpg" alt="image-20200709191049617" style="zoom:67%;" />

<p>4、基本的环境安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis-6.0.5]<span class="comment"># yum install gcc-c++</span></span><br><span class="line">[root@localhost redis-6.0.5]<span class="comment"># make</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># make 报错了，解决办法：升级 gcc</span></span><br><span class="line"></span><br><span class="line">make[1]: *** [server.o] Error 1</span><br><span class="line">make[1]: Leaving directory `/usr/local/src/redis-6.0.5/src<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make: *** [all] Error 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 升级 gcc	</span></span><br><span class="line"><span class="string">[root@localhost redis-6.0.5]# yum -y install centos-release-scl</span></span><br><span class="line"><span class="string">[root@localhost redis-6.0.5]# yum -y install devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 临时启用 gcc9</span></span><br><span class="line"><span class="string">[root@localhost redis-6.0.5]# scl enable devtoolset-9 bash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 长期使用 </span></span><br><span class="line"><span class="string">[root@localhost redis-6.0.5]# echo &quot;source /opt/rh/devtoolset-9/enable&quot; &gt;&gt;/etc/profile</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 安装成功会出现</span></span><br><span class="line"><span class="string">Hint: It&#x27;</span>s a good idea to run <span class="string">&#x27;make test&#x27;</span> ;)</span><br><span class="line"></span><br><span class="line">[root@localhost redis-6.0.5]<span class="comment"># make install</span></span><br><span class="line"><span class="built_in">cd</span> src &amp;&amp; make install</span><br><span class="line">make[1]: Entering directory `/usr/local/src/redis-6.0.5/src<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Hint: It&#x27;</span>s a good idea to run <span class="string">&#x27;make test&#x27;</span> ;)</span><br><span class="line"></span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">make[1]: Leaving directory `/usr/local/src/redis-6.0.5/src<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[root@localhost redis-6.0.5]#</span></span><br></pre></td></tr></table></figure>

<p>5、redis 的默认安装路径：<code>/usr/local/bin</code></p>
<p><img src="https://s2.loli.net/2023/07/22/JRewDK5lO1p4aT3.jpg" alt="image-20200709192625352"></p>
<p>6、将 redis 配置文件复制到当前目录</p>
<p><img src="https://s2.loli.net/2023/07/22/aTvZKIEhmczrP9Q.jpg" alt="image-20200709192840646"></p>
<p>7、redis 默认不是后台启动的，修改配置文件</p>
<p><img src="https://s2.loli.net/2023/07/22/3HVprKD1S75vTRG.jpg" alt="image-20200709193013031"></p>
<p>8、启动 redis 服务</p>
<p><img src="https://s2.loli.net/2023/07/22/bpWFaZtvAQ4mlxn.jpg" alt="image-20200709193203460"></p>
<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><p><strong>redis-benchmark</strong> 是一个官方自带的性能测试工具</p>
<p>命令参数如下：</p>
<p><img src="https://s2.loli.net/2023/07/22/Qh6MicyCafSGd2l.jpg" alt="image-20200709215712113"></p>
<p>简单测试一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试：100个并发连接，每个并发100000个请求</span></span><br><span class="line">redis-benchmark -h localhost -p 6379 -c 100 -n 100000</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/07/22/fADpsnBtUhXjgeY.jpg" alt="image-20200709220626415"></p>
<p>如何分析：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]<span class="comment"># ./redis-benchmark -h localhost -p 6379 -c 100 -n 100000</span></span><br><span class="line">====== SET ======</span><br><span class="line">  100000 requests completed <span class="keyword">in</span> 3.47 seconds				<span class="comment"># 10万个请求</span></span><br><span class="line">  100 parallel clients									<span class="comment"># 100的并发</span></span><br><span class="line">  3 bytes payload										<span class="comment"># 每次写入3个字节</span></span><br><span class="line">  keep alive: 1											<span class="comment"># 只有一台服务器来处理请求，单机性能</span></span><br><span class="line">  host configuration <span class="string">&quot;save&quot;</span>: 900 1 300 10 60 10000</span><br><span class="line">  host configuration <span class="string">&quot;appendonly&quot;</span>: no</span><br><span class="line">  multi-thread: no</span><br><span class="line"></span><br><span class="line">0.00% &lt;= 0.6 milliseconds</span><br><span class="line">0.02% &lt;= 0.7 milliseconds</span><br><span class="line">3.56% &lt;= 1.2 milliseconds</span><br><span class="line">6.57% &lt;= 1.3 milliseconds</span><br><span class="line">10.28% &lt;= 1.4 milliseconds</span><br><span class="line">14.41% &lt;= 1.5 milliseconds</span><br><span class="line">18.84% &lt;= 1.6 milliseconds</span><br><span class="line">23.53% &lt;= 1.7 milliseconds</span><br><span class="line">99.91% &lt;= 28 milliseconds</span><br><span class="line">99.96% &lt;= 29 milliseconds</span><br><span class="line">99.98% &lt;= 32 milliseconds</span><br><span class="line">99.99% &lt;= 33 milliseconds</span><br><span class="line">100.00% &lt;= 33 milliseconds</span><br><span class="line">28785.26 requests per second							<span class="comment"># 平均每秒处理 28785.26 个请求</span></span><br></pre></td></tr></table></figure>

<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>Redis 默认有 16 个数据库（配置文件中）</p>
<p><img src="https://s2.loli.net/2023/07/22/NFSjyUsuQcgtEqw.jpg" alt="image-20200709221505611"></p>
<p>默认使用的是第 0 个</p>
<p>可以使用 select 进行切换数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换数据库</span></span><br><span class="line">127.0.0.1:6379&gt; select 3</span><br><span class="line">OK</span><br><span class="line"><span class="comment"># 查询数据库大小</span></span><br><span class="line">127.0.0.1:6379[3]&gt; dbsize</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379[3]&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/07/22/jb19xpcBUiIkWea.jpg" alt="image-20200709221859432"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; keys *		<span class="comment"># 查看所有的 key</span></span><br><span class="line">1) <span class="string">&quot;name&quot;</span></span><br><span class="line">127.0.0.1:6379[3]&gt;</span><br></pre></td></tr></table></figure>

<p>清空当前数据库：<code>flushdb</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; flushdb</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; keys *</span><br><span class="line">(empty array)</span><br><span class="line">127.0.0.1:6379[3]&gt;</span><br></pre></td></tr></table></figure>

<p>清空所有数据库：<code>flushall</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; select 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;mylist:&#123;tag&#125;&quot;</span></span><br><span class="line">2) <span class="string">&quot;counter:&#123;tag&#125;:__rand_int__&quot;</span></span><br><span class="line">3) <span class="string">&quot;key:&#123;tag&#125;:__rand_int__&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; select 3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; flushall</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; select 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">(empty array)</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><span style='color: red'>Redis 是单线程的！</span></p>
</blockquote>
<p>Redis 是基于内存操作的，CPU 不是 Redis 的性能瓶颈，Redis 的瓶颈是在于机器的内存和网络的带宽。所以就使用了单线程</p>
<p><strong>Redis 单线程为什么这么快？</strong></p>
<p>Redis 是 C 语言写的，官方提供的数据为 100000+ 的 QPS，完全不比同样使用 key &#x3D;&gt; value 的 Memcache 差</p>
<p>误区：</p>
<ul>
<li><p>高性能一定是多线程？</p>
</li>
<li><p>多线程（CPU 调度，上下文切换会消耗资源）一定比单线程效率高（CPU &gt; 内存 &gt; 硬盘）</p>
</li>
</ul>
<p>核心：Redis 是将数据存储在内存的，所以单线程处理是效率最好的，对于内存系统来说，如果没有上下文切换，效率就是最高的，多次读写都是在一个 CPU 上的</p>
<h1 id="五大数据类型"><a href="#五大数据类型" class="headerlink" title="五大数据类型"></a>五大数据类型</h1><blockquote>
<p>官网文档</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/07/22/PIk3FxuLcC8lQiZ.jpg" alt="image-20200709223659344"></p>
<p><img src="https://s2.loli.net/2023/07/22/8HQPKmYbMjVkxcJ.jpg" alt="image-20200709224106251"></p>
<h2 id="Redis-key"><a href="#Redis-key" class="headerlink" title="Redis-key"></a>Redis-key</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]# ./redis-cli -p 6379</span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; set name cat				# set key</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;name&quot;</span><br><span class="line">127.0.0.1:6379&gt; set age 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;age&quot;</span><br><span class="line">2) &quot;name&quot;</span><br><span class="line">127.0.0.1:6379&gt; move age 1					# 移除当前 key</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">2) &quot;name&quot;</span><br><span class="line">127.0.0.1:6379&gt; exists name					# 判断当前 key 是否存在</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; type name					# 查看当前 key 的类型</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; expire name 10				# 设置 key 的过期时间</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;cat&quot;</span><br><span class="line">127.0.0.1:6379&gt; ttl name					# 查看当前 key 的剩余时间</span><br><span class="line">(integer) -2</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用官网查询命令</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/07/22/rH5ZtSNkqGMwzKi.jpg" alt="image-20200709225931808"></p>
<h2 id="String（字符串）"><a href="#String（字符串）" class="headerlink" title="String（字符串）"></a>String（字符串）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key1 v1					<span class="comment"># 设置值</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get key1					<span class="comment"># 获取值</span></span><br><span class="line"><span class="string">&quot;v1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; keys *						<span class="comment"># 查看所有 key</span></span><br><span class="line">1) <span class="string">&quot;key1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; exists key1					<span class="comment"># 判断某一个key是否存在</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; append key1 hello			<span class="comment"># 追加字符串，如果当前key不存在，相当于set key</span></span><br><span class="line">(<span class="built_in">integer</span>) 7</span><br><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line"><span class="string">&quot;v1hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; append key1 <span class="string">&quot;, world&quot;</span>		</span><br><span class="line">(<span class="built_in">integer</span>) 14</span><br><span class="line">127.0.0.1:6379&gt; strlen key1					<span class="comment"># 获取key的长度</span></span><br><span class="line">(<span class="built_in">integer</span>) 14</span><br><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line"><span class="string">&quot;v1hello, world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> views 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get views</span><br><span class="line"><span class="string">&quot;0&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; incr views					<span class="comment"># 自增1</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; incr views</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; get views</span><br><span class="line"><span class="string">&quot;2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; decr views					<span class="comment"># 自减1</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; get views</span><br><span class="line"><span class="string">&quot;1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; incrby views 10				<span class="comment"># 指定步长，设置增量</span></span><br><span class="line">(<span class="built_in">integer</span>) 11</span><br><span class="line">127.0.0.1:6379&gt; incrby views 10</span><br><span class="line">(<span class="built_in">integer</span>) 21</span><br><span class="line">127.0.0.1:6379&gt; decrby views 5</span><br><span class="line">(<span class="built_in">integer</span>) 16</span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key1 <span class="string">&quot;hello world&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line"><span class="string">&quot;hello world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; getrange key1 0 5			<span class="comment"># 截取字符串</span></span><br><span class="line"><span class="string">&quot;hello &quot;</span></span><br><span class="line">127.0.0.1:6379&gt; getrange key1 0 -1			<span class="comment"># 获取所有字符串，相当于get</span></span><br><span class="line"><span class="string">&quot;hello world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key2 <span class="string">&quot;abcdefg&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get key2</span><br><span class="line"><span class="string">&quot;abcdefg&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; setrange key2 0 <span class="string">&quot;xx&quot;</span>		<span class="comment"># 替换指定位置开始的字符串</span></span><br><span class="line">(<span class="built_in">integer</span>) 7</span><br><span class="line">127.0.0.1:6379&gt; get key2</span><br><span class="line"><span class="string">&quot;xxcdefg&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line">127.0.0.1:6379&gt; setex key3 10 <span class="string">&quot;2020&quot;</span>		<span class="comment"># 设置key3的值为2020，10秒过期</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; ttl key3</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; get key3</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; setnx mykey <span class="string">&quot;apple&quot;</span>			<span class="comment"># 如果mykey不存在则设置</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;key2&quot;</span></span><br><span class="line">2) <span class="string">&quot;mykey&quot;</span></span><br><span class="line">3) <span class="string">&quot;key1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; setnx mykey <span class="string">&quot;banner&quot;</span>		<span class="comment"># 如果mykey不存在则设置（返回0，创建失败）</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; get mykey</span><br><span class="line"><span class="string">&quot;apple&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; flushall</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">(empty array)</span><br><span class="line">127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3		<span class="comment"># 同时设置多个值</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;k2&quot;</span></span><br><span class="line">2) <span class="string">&quot;k1&quot;</span></span><br><span class="line">3) <span class="string">&quot;k3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; mget k1 k2 k3				<span class="comment"># 同时获取多个值</span></span><br><span class="line">1) <span class="string">&quot;v1&quot;</span></span><br><span class="line">2) <span class="string">&quot;v2&quot;</span></span><br><span class="line">3) <span class="string">&quot;v3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; msetnx k1 v1 k4 v4			<span class="comment"># msetnx 是一个原子性操作，一起成功，一起失败</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; get k4</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; getset db redis				<span class="comment"># 如果不存在则返回nil，不存在则设置值</span></span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; get db</span><br><span class="line"><span class="string">&quot;redis&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; getset db mongodb			<span class="comment"># 如果存在则返回值，并设置新的值</span></span><br><span class="line"><span class="string">&quot;redis&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get db</span><br><span class="line"><span class="string">&quot;mongodb&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>想象一个简单业务场景：</p>
<p>要存储用户1的关注数 10、粉丝数 20；用户2的关注数 5、粉丝数 30；</p>
<p>使用 redis 如何存储</p>
</blockquote>
<p><strong>方案一：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; mset user:1 &#123;follow:10,fans:20&#125; user:2 &#123;follow:5,fans:30&#125;</span><br><span class="line">OK </span><br><span class="line">127.0.0.1:6379&gt; mget user:1 user:2</span><br><span class="line">1) <span class="string">&quot;&#123;follow:10,fans:20&#125;&quot;</span></span><br><span class="line">2) <span class="string">&quot;&#123;follow:5,fans:30&#125;&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p>得到数据后，进行解析</p>
<p><strong>方案二：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; mset user:1:follow 10 user:1:fans 20 user:2:follow 5 user:2:fans 30</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mget user:1:follow user:1:fans user:2:follow user:2:fans</span><br><span class="line">1) <span class="string">&quot;10&quot;</span></span><br><span class="line">2) <span class="string">&quot;20&quot;</span></span><br><span class="line">3) <span class="string">&quot;5&quot;</span></span><br><span class="line">4) <span class="string">&quot;30&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p>得到数据后，不用解析</p>
<h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><p>  <img src="https://s2.loli.net/2023/07/22/iUX8NEykwqFbR2g.jpg" alt="image-20200710100505779"></p>
<p>在 redis 里面，栈、堆、队列、阻塞队列都可以用 list 来实现</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有的list命令都是l开头的</span></span><br><span class="line">127.0.0.1:6379&gt; lpush list one				<span class="comment"># 将一个或多个值插入到列表头部</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lpush list two</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lpush list three</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">3) <span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 1</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; rpush list xxx				<span class="comment"># 将一个或多个值插入到列表尾部</span></span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">3) <span class="string">&quot;one&quot;</span></span><br><span class="line">4) <span class="string">&quot;xxx&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">3) <span class="string">&quot;one&quot;</span></span><br><span class="line">4) <span class="string">&quot;xxx&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lpop list					<span class="comment"># 移除list头部</span></span><br><span class="line"><span class="string">&quot;three&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; rpop list					<span class="comment"># 移除list尾部</span></span><br><span class="line"><span class="string">&quot;xxx&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;two&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;two&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lindex list 1				<span class="comment"># 通过下标获取list某个值</span></span><br><span class="line"><span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lindex list 0</span><br><span class="line"><span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; lpush list one two three</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; llen list					<span class="comment"># 返回列表长度</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; lpush list three</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;three&quot;</span></span><br><span class="line">3) <span class="string">&quot;two&quot;</span></span><br><span class="line">4) <span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrem list 1 one				<span class="comment"># 移除list集合中指定个数的value，精确匹配</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;three&quot;</span></span><br><span class="line">3) <span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrem list 1 three</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lpush list three</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrem list 2 three</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; lpush list <span class="string">&#x27;helllo&#x27;</span> <span class="string">&#x27;hello1&#x27;</span> <span class="string">&#x27;hello2&#x27;</span> <span class="string">&#x27;hello3&#x27;</span></span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;hello3&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello2&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">4) <span class="string">&quot;helllo&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; ltrim list 1 2				<span class="comment"># 通过下标截取指定长度，会改变list，只剩下截取的元素</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;hello2&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; lpush mylist <span class="string">&quot;hello&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lpush mylist <span class="string">&quot;hello1&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lpush mylist <span class="string">&quot;hello2&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; rpoplpush mylist mylist1		<span class="comment"># 移除列表最后一个元素，移动到新的列表中并返回</span></span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1				<span class="comment"># 查看原来的列表</span></span><br><span class="line">1) <span class="string">&quot;hello2&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange mylist1 0 -1				<span class="comment"># 查看新的列表</span></span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; flushdb</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; exists list						<span class="comment"># 判断列表是否存在</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; lset list 0 item				<span class="comment"># 列表不存在更新会报错</span></span><br><span class="line">(error) ERR no such key</span><br><span class="line">127.0.0.1:6379&gt; lpush list value1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 0</span><br><span class="line">1) <span class="string">&quot;value1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lset list 0 item				<span class="comment"># 如果存在更新指定下标的值</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 0</span><br><span class="line">1) <span class="string">&quot;item&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; rpush mylist hello</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush mylist world</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; linsert mylist before world other	<span class="comment"># 将一个值插入到列表中某个元素的前面或后面</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;other&quot;</span></span><br><span class="line">3) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>list 小结</p>
</blockquote>
<ul>
<li>实际上是一个链表，left、right 都可以插入值</li>
<li>如果 key 不存在，创建新的链表</li>
<li>如果 key 存在，新增内容</li>
<li>如果移除了所有值，就是空链表，也意味着该 key 也不存在了</li>
<li>在两边插入或改动值，效率最高。</li>
</ul>
<p>消息队列（lpush rpop），栈（lpush lpop）</p>
<h2 id="Set（集合）"><a href="#Set（集合）" class="headerlink" title="Set（集合）"></a>Set（集合）</h2><p>set 中的值是不能重复的（无序不重复集合）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; sadd myset hello				<span class="comment"># 向set集合中添加元素</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset world				</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers myset					<span class="comment"># 查看set集合所有元素</span></span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sismember myset hello			<span class="comment"># 查询某值是否存在于set集合中</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sismember myset <span class="built_in">cat</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; scard myset						<span class="comment"># 集合中元素个数</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; srem myset world				<span class="comment"># 将某值移出set</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers myset</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER myset				<span class="comment"># 随机取出一个元素</span></span><br><span class="line"><span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER myset</span><br><span class="line"><span class="string">&quot;cat&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SRAND2MEMBER myset</span><br><span class="line"><span class="string">&quot;dog&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; spop myset						<span class="comment"># 随机移出一个元素</span></span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; spop myset</span><br><span class="line"><span class="string">&quot;dog&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset</span><br><span class="line">1) <span class="string">&quot;cat&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################################## </span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; sadd myset hello</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset world</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset dog</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;dog&quot;</span></span><br><span class="line">3) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sadd myset2 <span class="built_in">cat</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset2</span><br><span class="line">2) <span class="string">&quot;dog&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smove myset myset2 dog			<span class="comment"># 将一个集合中指定的元素移动到另一个集合中</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS myset2</span><br><span class="line">1) <span class="string">&quot;cat&quot;</span></span><br><span class="line">2) <span class="string">&quot;dog&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################################## </span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; sadd key1 a</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd key1 b</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd key1 c</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd key2 c</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd key2 d</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd key2 e</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; SDIFF key1 key2					<span class="comment"># 查看两个集合的差集</span></span><br><span class="line">1) <span class="string">&quot;b&quot;</span></span><br><span class="line">2) <span class="string">&quot;a&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SINTER key1 key2				<span class="comment"># 查看两个几个的交集</span></span><br><span class="line">1) <span class="string">&quot;c&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; SUNION key1 key2				<span class="comment"># 并集</span></span><br><span class="line">1) <span class="string">&quot;b&quot;</span></span><br><span class="line">2) <span class="string">&quot;c&quot;</span></span><br><span class="line">3) <span class="string">&quot;a&quot;</span></span><br><span class="line">4) <span class="string">&quot;e&quot;</span></span><br><span class="line">5) <span class="string">&quot;d&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Hash（哈希）"><a href="#Hash（哈希）" class="headerlink" title="Hash（哈希）"></a>Hash（哈希）</h2><p>Map 集合，key-map 这时候的值是一个 map 集合</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset myhash field1 hello					<span class="comment"># set一个具体的 key-value</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hget myhash field1							<span class="comment"># 获取一个字段值</span></span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hmset myhash field1 hello field2 world		<span class="comment"># set多个key-value</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hget myhash field1</span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hget myhash field2</span><br><span class="line"><span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hmget myhash field1 field2					<span class="comment"># 获取多个字段值</span></span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hgetall myhash								<span class="comment"># 查看指定key的hash 所有key-value</span></span><br><span class="line">1) <span class="string">&quot;field1&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">3) <span class="string">&quot;field2&quot;</span></span><br><span class="line">4) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hdel myhash field1							<span class="comment"># 删除hash指定的字段key</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall myhash</span><br><span class="line">1) <span class="string">&quot;field2&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hlen myhash									<span class="comment"># 获取指定key的hash长度</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hmset myhash field1 hello</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; hlen myhash</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; hgetall myhash</span><br><span class="line">1) <span class="string">&quot;field2&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line">3) <span class="string">&quot;field1&quot;</span></span><br><span class="line">4) <span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; HEXISTS myhash field1						<span class="comment"># 判断hash指定字段是否存在</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; HEXISTS myhash field3</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; hkeys myhash								<span class="comment"># 获取hash所有字段的key</span></span><br><span class="line">1) <span class="string">&quot;field2&quot;</span></span><br><span class="line">2) <span class="string">&quot;field1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hvals myhash								<span class="comment"># 获取hash所有字段的value</span></span><br><span class="line">1) <span class="string">&quot;world&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; HINCRBY myhash field3 1						<span class="comment"># 指定增量</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; HINCRBY myhash field3 3</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; HINCRBY myhash field3 -1</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; HSETNX myhash field4 dog					<span class="comment"># 不存在则可以设置</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; HSETNX myhash field4 <span class="built_in">cat</span>					<span class="comment"># 存在则不能设置</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Zset（有序集合）"><a href="#Zset（有序集合）" class="headerlink" title="Zset（有序集合）"></a>Zset（有序集合）</h2><p>在 set 的基础上，增加了一个值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd myset 1 one					<span class="comment"># 添加一个值</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd myset 2 two 3 three			<span class="comment"># 添加多个值</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; zrange myset 0 -1</span><br><span class="line">1) <span class="string">&quot;one&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">3) <span class="string">&quot;three&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ZRANGEBYSCORE key min max</span></span><br><span class="line">127.0.0.1:6379&gt; zadd salary 2500 zhangsan</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd salary 3000 zlisi</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd salary 100 wangwu</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; ZRANGEBYSCORE salary -inf +inf			<span class="comment"># 显示所有用户 从小到大</span></span><br><span class="line">1) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">3) <span class="string">&quot;zlisi&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGEBYSCORE salary -inf +inf withscores		<span class="comment"># 显示所有用户并附带工资</span></span><br><span class="line">1) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">2) <span class="string">&quot;100&quot;</span></span><br><span class="line">3) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">4) <span class="string">&quot;2500&quot;</span></span><br><span class="line">5) <span class="string">&quot;zlisi&quot;</span></span><br><span class="line">6) <span class="string">&quot;3000&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGEBYSCORE salary -inf 2500		<span class="comment">#显示工资小于等于2500的用户，升序排列</span></span><br><span class="line">1) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGEBYSCORE salary -inf 2500 withscores	</span><br><span class="line">1) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">2) <span class="string">&quot;100&quot;</span></span><br><span class="line">3) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">4) <span class="string">&quot;2500&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; zrange salary 0 -1</span><br><span class="line">1) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">3) <span class="string">&quot;zlisi&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zrem salary zlisi			<span class="comment"># 移除有序集合中的指定元素</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zrange salary 0 -1</span><br><span class="line">1) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">2) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; ZREVRANGE salary 0 -1		<span class="comment"># 从大到小排序</span></span><br><span class="line">1) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">2) <span class="string">&quot;wangwu&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zcard salary				<span class="comment"># 查看集合中元素的个数</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; zadd myset 1 hello 2 world 3 <span class="built_in">cat</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; zcount myset 1 3		<span class="comment"># 获取指定区间的元素数量</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; zcount myset 1 2</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h1 id="三种特殊类型"><a href="#三种特殊类型" class="headerlink" title="三种特殊类型"></a>三种特殊类型</h1><h2 id="geospatial-地理位置"><a href="#geospatial-地理位置" class="headerlink" title="geospatial 地理位置"></a>geospatial 地理位置</h2><p>可以推算地理位置的信息，比如两地之间的距离，方圆几里的人</p>
<p>可以查询一些测试数据：<a target="_blank" rel="noopener" href="http://www.jsons.cn/lngcode/">http://www.jsons.cn/lngcode/</a></p>
<p>中文官网文档：<a target="_blank" rel="noopener" href="https://www.redis.net.cn/order/3685.html">https://www.redis.net.cn/order/3685.html</a></p>
<p>只有六个命令：</p>
<p><img src="https://s2.loli.net/2023/07/22/rdp5socPAOKRI8W.jpg" alt="image-20200710183336838"></p>
<blockquote>
<p>1、geoadd</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加地理位置</span></span><br><span class="line"><span class="comment"># 南北极 无法直接添加，城市数据一般通过程序直接导入，</span></span><br><span class="line"><span class="comment"># 参数：key value（纬度、经度、城市）</span></span><br><span class="line"><span class="comment"># 有效的经度从-180度到180度。</span></span><br><span class="line"><span class="comment"># 有效的纬度从-85.05112878度到85.05112878度。</span></span><br><span class="line"><span class="comment"># 当坐标位置超出上述指定范围时，该命令将会返回一个错误</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 116.40 39.90 beijing</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 121.47 31.23 shanghai</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 106.50 29.53 chongqing 114.05 22.52 shenzhen</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 120.16 30.24 hangzhou 108.96 34.26 xian</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>geopos</p>
</blockquote>
<p>获得的定位一定是一个坐标值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geopos china:city beijing shanghai</span><br><span class="line">1) 1) <span class="string">&quot;116.39999896287918091&quot;</span></span><br><span class="line">   2) <span class="string">&quot;39.90000009167092543&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;121.47000163793563843&quot;</span></span><br><span class="line">   2) <span class="string">&quot;31.22999903975783553&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>geodist</p>
</blockquote>
<p> <strong>GEODIST 命令 - 返回两个给定位置之间的距离</strong></p>
<p>如果两个位置之间的其中一个不存在， 那么命令返回空值。</p>
<p>指定单位的参数 unit 必须是以下单位的其中一个：</p>
<ul>
<li><strong>m</strong> 表示单位为米。</li>
<li><strong>km</strong> 表示单位为千米。</li>
<li><strong>mi</strong> 表示单位为英里。</li>
<li><strong>ft</strong> 表示单位为英尺。</li>
</ul>
<p>如果用户没有显式地指定单位参数， 那么 <code>GEODIST</code> 默认使用米作为单位。</p>
<p><code>GEODIST</code> 命令在计算距离时会假设地球为完美的球形， 在极限情况下， 这一假设最大会造成 0.5% 的误差。</p>
<p><strong>返回值</strong></p>
<p>计算出的距离会以双精度浮点数的形式被返回。 如果给定的位置元素不存在， 那么命令返回空值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEODIST china:city beijing shanghai</span><br><span class="line"><span class="string">&quot;1067378.7564&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GEODIST china:city beijing shanghai km</span><br><span class="line"><span class="string">&quot;1067.3788&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>georadius</p>
</blockquote>
<p><strong>GEORADIUS 命令 - 以给定的经纬度为中心， 找出某一半径内的元素</strong></p>
<p>以给定的经纬度为中心， 返回键包含的位置元素当中， 与中心的距离不超过给定最大距离的所有位置元素。</p>
<p>范围可以使用以下其中一个单位：</p>
<ul>
<li><strong>m</strong> 表示单位为米。</li>
<li><strong>km</strong> 表示单位为千米。</li>
<li><strong>mi</strong> 表示单位为英里。</li>
<li><strong>ft</strong> 表示单位为英尺。</li>
</ul>
<p>在给定以下可选项时， 命令会返回额外的信息：</p>
<ul>
<li><code>WITHDIST</code>：在返回位置元素的同时， 将位置元素与中心之间的距离也一并返回。 距离的单位和用户给定的范围单位保持一致。</li>
<li><code>WITHCOORD</code>：将位置元素的经度和维度也一并返回。</li>
<li><code>WITHHASH</code>：以 52 位有符号整数的形式， 返回位置元素经过原始 geohash 编码的有序集合分值。 这个选项主要用于底层应用或者调试， 实际中的作用并不大。</li>
</ul>
<p>命令默认返回未排序的位置元素。 通过以下两个参数， 用户可以指定被返回位置元素的排序方式：</p>
<ul>
<li><code>ASC</code>：根据中心的位置， 按照从近到远的方式返回位置元素。</li>
<li><code>DESC</code>：根据中心的位置， 按照从远到近的方式返回位置元素。</li>
</ul>
<p>在默认情况下， GEORADIUS 命令会返回所有匹配的位置元素。 虽然用户可以使用 <strong>COUNT <code>&lt;count&gt;</code></strong> 选项去获取前 N 个匹配元素， 但是因为命令在内部可能会需要对所有被匹配的元素进行处理， 所以在对一个非常大的区域进行搜索时， 即使只使用 <code>COUNT</code> 选项去获取少量元素， 命令的执行速度也可能会非常慢。 但是从另一方面来说， 使用 <code>COUNT</code> 选项去减少需要返回的元素数量， 对于减少带宽来说仍然是非常有用的。</p>
<p><strong>返回值</strong></p>
<ul>
<li>在没有给定任何 <code>WITH</code> 选项的情况下， 命令只会返回一个像 [“New York”,”Milan”,”Paris”] 这样的线性（linear）列表。</li>
<li>在指定了 <code>WITHCOORD</code> 、 <code>WITHDIST</code> 、 <code>WITHHASH</code> 等选项的情况下， 命令返回一个二层嵌套数组， 内层的每个子数组就表示一个元素。</li>
</ul>
<p>在返回嵌套数组时， 子数组的第一个元素总是位置元素的名字。 至于额外的信息， 则会作为子数组的后续元素， 按照以下顺序被返回：</p>
<ol>
<li>以浮点数格式返回的中心与位置元素之间的距离， 单位与用户指定范围时的单位一致。</li>
<li>geohash 整数。</li>
<li>由两个元素组成的坐标，分别为经度和纬度。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km	<span class="comment"># 以100,30这个经纬度为中心，寻找方圆500km的城市</span></span><br><span class="line">1) <span class="string">&quot;chongqing&quot;</span></span><br><span class="line">2) <span class="string">&quot;xian&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 1000 km  </span><br><span class="line">1) <span class="string">&quot;chongqing&quot;</span></span><br><span class="line">2) <span class="string">&quot;xian&quot;</span></span><br><span class="line">3) <span class="string">&quot;shenzhen&quot;</span></span><br><span class="line">4) <span class="string">&quot;hangzhou&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withdist <span class="comment"># 以100,30这个经纬度为中心，寻找方圆500km的城市，并返回距离</span></span><br><span class="line">1) 1) <span class="string">&quot;chongqing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;341.9374&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;xian&quot;</span></span><br><span class="line">   2) <span class="string">&quot;483.8340&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 500 km withcoord <span class="comment"># 以100,30这个经纬度为中心，寻找方圆500km的城市，并返回经纬度</span></span><br><span class="line">1) 1) <span class="string">&quot;chongqing&quot;</span></span><br><span class="line">   2) 1) <span class="string">&quot;106.49999767541885376&quot;</span></span><br><span class="line">      2) <span class="string">&quot;29.52999957900659211&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;xian&quot;</span></span><br><span class="line">   2) 1) <span class="string">&quot;108.96000176668167114&quot;</span></span><br><span class="line">      2) <span class="string">&quot;34.25999964418929977&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GEORADIUS china:city 110 30 1000 km withcoord withdist count 2 <span class="comment">#以100,30这个经纬度为中心，寻找方圆1000km的2个城市</span></span><br><span class="line">1) 1) <span class="string">&quot;chongqing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;341.9374&quot;</span></span><br><span class="line">   3) 1) <span class="string">&quot;106.49999767541885376&quot;</span></span><br><span class="line">      2) <span class="string">&quot;29.52999957900659211&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;xian&quot;</span></span><br><span class="line">   2) <span class="string">&quot;483.8340&quot;</span></span><br><span class="line">   3) 1) <span class="string">&quot;108.96000176668167114&quot;</span></span><br><span class="line">      2) <span class="string">&quot;34.25999964418929977&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>georadiusbymember</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER china:city beijing 1000 km	<span class="comment"># 找出位于指定元素周围的其他元素</span></span><br><span class="line">1) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">2) <span class="string">&quot;xian&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>geohash</p>
</blockquote>
<p>该命令将返回11个字符的 Geohash 字符串</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将二维的经纬度，转换为一维的字符串，如果连个字符串越接近，那么距离越近</span></span><br><span class="line">127.0.0.1:6379&gt; GEOHASH china:city beijing shanghai</span><br><span class="line">1) <span class="string">&quot;wx4fbxxfke0&quot;</span></span><br><span class="line">2) <span class="string">&quot;wtw3sj5zbj0&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong><span style='color: red'>geo 底层就是基于 zset，可以通过 zset 命令操作 geo</span></strong></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrange china:city 0 -1</span><br><span class="line">1) <span class="string">&quot;chongqing&quot;</span></span><br><span class="line">2) <span class="string">&quot;xian&quot;</span></span><br><span class="line">3) <span class="string">&quot;shenzhen&quot;</span></span><br><span class="line">4) <span class="string">&quot;hangzhou&quot;</span></span><br><span class="line">5) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">6) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zrem china:city beijing</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h2 id="hyperloglog"><a href="#hyperloglog" class="headerlink" title="hyperloglog"></a>hyperloglog</h2><blockquote>
<p>简介</p>
</blockquote>
<p>hyperloglog 是用来统计基数的算法</p>
<p><strong>网页的 UV （一个人访问网站多次，但还是算作一个人）</strong> </p>
<p>传统的方式，利用 set 来保存用户id，因为 set 不允许重复，就可以统计 set 中的元素作为标准判断</p>
<p>这个方式如果保存大量的用户 id，就会比较麻烦（消耗大量的空间保存用户id），我们的目的是计数，而不是用来保存用户id</p>
<p>优点：Hyperloglog 占用的内存是固定的，如果从内存角度来说，hyperloglog 一定是首选</p>
<p>0.81% 错误率</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PFADD mykey a b c d e f g 		<span class="comment"># 创建第一组数据</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT mykey					<span class="comment"># 统计第一组数据的基数数量</span></span><br><span class="line">(<span class="built_in">integer</span>) 7</span><br><span class="line">127.0.0.1:6379&gt; PFADD mykey2 e f g h i j k</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT mykey2</span><br><span class="line">(<span class="built_in">integer</span>) 7</span><br><span class="line">127.0.0.1:6379&gt; PFMERGE mykey3 mykey mykey2		<span class="comment"># 合并两组，返回两组的并集生成新的一组</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT mykey3					<span class="comment"># 查看新的一组基数数量</span></span><br><span class="line">(<span class="built_in">integer</span>) 11</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p>如果允许容错，一定使用 hyperloglog</p>
<p>如果不允许容错，使用 set 或自己的数据类型就可以</p>
<h2 id="bitmaps"><a href="#bitmaps" class="headerlink" title="bitmaps"></a>bitmaps</h2><blockquote>
<p>位存储</p>
</blockquote>
<p>一种位图数据结构，操作二进制来进行记录，只有 0 和 1 两个状态 </p>
<blockquote>
<p>业务场景一：</p>
</blockquote>
<p>记录用户周一到周日（0-6）的签到情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setbit sign_1 0 1		<span class="comment"># 周一 已签到</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign_1 1 1		<span class="comment"># 周二 已签到</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign_1 2 1		<span class="comment"># 周三 已签到</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign_1 3 0		<span class="comment"># 周四 未签到</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign_1 4 0		<span class="comment"># 周五 未签到</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign_1 5 1		<span class="comment"># 周六 已签到</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign_1 6 0		<span class="comment"># 周日 未签到</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit sign_1 2			<span class="comment"># 用户1周三的签到情况</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; bitcount sign_1			<span class="comment"># 用户1这一周签到总数</span></span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>业务场景二：</p>
</blockquote>
<p>用户在线状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户id为710的今日在线</span></span><br><span class="line">127.0.0.1:6379&gt; setbit online 710 1</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line"><span class="comment"># 用户id为711的今日不在线</span></span><br><span class="line">127.0.0.1:6379&gt; setbit online 711 0</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line"><span class="comment"># 获取用户id为710、711的在线情况</span></span><br><span class="line">127.0.0.1:6379&gt; getbit online 710</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit online 711</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>ACID 原则：</p>
<p><strong>原子性（Atomicity）</strong></p>
<p>原子性是指事务是一个不可分割的工作单位，事务中的操作要么都发生，要么都不发生。</p>
<p><strong>一致性（Consistency）</strong></p>
<p>事务前后数据的完整性必须保持一致。</p>
<p><strong>隔离性（Isolation）</strong></p>
<p>事务的隔离性是多个用户并发访问数据库时，数据库为每一个用户开启的事务，不能被其他事务的操作数据所干扰，多个并发事务之间要相互隔离。</p>
<p><strong>持久性（Durability）</strong></p>
<p>持久性是指一个事务一旦被提交，它对数据库中数据的改变就是永久性的，接下来即使数据库发生故障也不应该对其有任何影响</p>
<blockquote>
<p><span style='color: red'>redis 的事务没有隔离性的概念</span></p>
</blockquote>
<p>redis 事务的特性：</p>
<p>一次性、顺序性、排他性</p>
<p>redis 事务的基础命令：</p>
<ul>
<li>开启事务（multi）</li>
<li>命令入队（……）</li>
<li>执行事务（exec）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi		<span class="comment"># 开启事务</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k3 v3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exec</span>		<span class="comment"># 执行事务</span></span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">3) <span class="string">&quot;v2&quot;</span></span><br><span class="line">4) OK</span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k4 v4</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; discard		<span class="comment"># 放弃事务，事务中的命令都不会被执行</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get k4</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>编译型异常（命令错误，事务中所有的命令都不会被执行）</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k3 v3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; getset k3		<span class="comment"># 命令错误</span></span><br><span class="line">(error) ERR wrong number of arguments <span class="keyword">for</span> <span class="string">&#x27;getset&#x27;</span> <span class="built_in">command</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k4 v4</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k5 v5</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exec</span>			<span class="comment"># 事务执行报错</span></span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors.</span><br><span class="line">127.0.0.1:6379&gt; get k1			<span class="comment"># 所有命令不生效</span></span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>运行时异常（运行错误，事务中的命令是可以正常执行的。运行错误的命令抛出异常）</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k1 <span class="string">&quot;v1&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; incr k1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k3 v3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; get k3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exec</span>		<span class="comment"># 事务执行成功</span></span><br><span class="line">1) (error) ERR value is not an <span class="built_in">integer</span> or out of range  <span class="comment"># 命令执行时错误</span></span><br><span class="line">2) OK</span><br><span class="line">3) OK</span><br><span class="line">4) <span class="string">&quot;v3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get k2		<span class="comment"># 事务中其他命令生效！</span></span><br><span class="line"><span class="string">&quot;v2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>redis 事务实现监控</p>
</blockquote>
<p>正常执行成功的情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> money 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> out 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; watch money 	<span class="comment"># 监控 money</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; DECRBY money 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; INCRBY out 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exec</span>			<span class="comment"># 事务正常执行</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 80</span><br><span class="line">2) (<span class="built_in">integer</span>) 20</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p><strong>测试多线程修改值，使用 <code>watch</code> 实现乐观锁</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; WATCH money			<span class="comment"># 监控 money</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; DECRBY money 10</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; INCRBY out 10</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exec</span>				<span class="comment"># 执行之前，另一个线程修改了 money，所以事务执行失败</span></span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; UNWATCH				<span class="comment"># 取消监控 money</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; watch money			<span class="comment"># 重新监控 money</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; DECRBY money 100</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incrby out 100</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exec</span>				<span class="comment"># 执行成功</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 900</span><br><span class="line">2) (<span class="built_in">integer</span>) 120</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h2 id="redis-conf-详解"><a href="#redis-conf-详解" class="headerlink" title="redis.conf 详解"></a>redis.conf 详解</h2><p>启动 redis 服务时，就是使用 redis.conf 启动的</p>
<blockquote>
<p>单位</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/07/22/2y67JBYerUwLG19.jpg" alt="image-20200711120203433"></p>
<p>配置文件中的 unit 单位对大小写不敏感</p>
<blockquote>
<p>包含文件</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/07/22/DXvNfidmeFclMVT.jpg" alt="image-20200711120255561"></p>
<p>可以包含其他配置文件</p>
<blockquote>
<p>网络</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> 127.0.0.1	<span class="comment"># 绑定的ip</span></span><br><span class="line">protected-mode <span class="built_in">yes</span>		<span class="comment"># 保护模式</span></span><br><span class="line">port 6379	<span class="comment"># 端口</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通用 GENERAL</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">daemonize <span class="built_in">yes</span>	<span class="comment"># 以守护进程的方式运行，默认是no，需要开启</span></span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志</span></span><br><span class="line"><span class="comment"># Specify the server verbosity level.</span></span><br><span class="line"><span class="comment"># This can be one of:</span></span><br><span class="line"><span class="comment"># debug (a lot of information, useful for development/testing)</span></span><br><span class="line"><span class="comment"># verbose (many rarely useful info, but not a mess like the debug level)</span></span><br><span class="line"><span class="comment"># notice (moderately verbose, what you want in production probably)	生产环境</span></span><br><span class="line"><span class="comment"># warning (only very important / critical messages are logged)</span></span><br><span class="line">loglevel notice</span><br><span class="line">logfile <span class="string">&quot;&quot;</span>	<span class="comment"># 日志文件目录</span></span><br><span class="line">databases 16	<span class="comment"># 数据库的数量，默认是16</span></span><br><span class="line">always-show-logo <span class="built_in">yes</span>	<span class="comment"># 是否总是显示logo</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>快照</p>
</blockquote>
<p>redis 是内存数据库，如果没有持久化，那么数据断电及失</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果900s内，如果至少有1个key进行过修改，就进行持久化操作</span></span><br><span class="line">save 900 1</span><br><span class="line"><span class="comment"># 如果300s内，如果至少有10个key进行过修改，就进行持久化操作</span></span><br><span class="line">save 300 10</span><br><span class="line"><span class="comment"># 如果60s内，有1000个key进行过修改，就进行持久化操作</span></span><br><span class="line">save 60 1000</span><br><span class="line"></span><br><span class="line">stop-writes-on-bgsave-error <span class="built_in">yes</span> <span class="comment"># 持久化如果出错，是否继续工作</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span> <span class="comment"># 是否压缩rdb文件，需要消耗一些cpu的资源</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span>	<span class="comment"># 保存rdb文件时，进行错误检查</span></span><br><span class="line"><span class="built_in">dir</span> ./	<span class="comment"># rdb文件保存的位置</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>REPLICATION 主从配置</p>
</blockquote>
<blockquote>
<p>SECURITY 安全</p>
</blockquote>
<p>可以设置 redis 的密码，默认是没有密码的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; config get requirepass				<span class="comment"># 查看当前密码</span></span><br><span class="line">1) <span class="string">&quot;requirepass&quot;</span></span><br><span class="line">2) <span class="string">&quot;&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; config <span class="built_in">set</span> requirepass <span class="string">&quot;123456&quot;</span>		<span class="comment"># 设置密码</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line">[root@localhost bin]<span class="comment"># ./redis-cli -p 6379			# 断开重新连接</span></span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">127.0.0.1:6379&gt; config get requirepass				<span class="comment"># 命令无权限</span></span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">127.0.0.1:6379&gt; auth 123456							<span class="comment"># 使用密码登录</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; config get requirepass</span><br><span class="line">1) <span class="string">&quot;requirepass&quot;</span></span><br><span class="line">2) <span class="string">&quot;123456&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CLIENTS 限制</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">maxclients 10000	<span class="comment"># 设置redis最大连接数量</span></span><br><span class="line">maxmemory &lt;bytes&gt;	<span class="comment"># redis 配置最大的内存容量</span></span><br><span class="line">maxmemory-policy noeviction	<span class="comment"># 内存到达上限时的处理策略</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># redis 中的默认的过期策略是 volatile-lru 。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置方式 config set maxmemory-policy volatile-lru </span></span><br><span class="line"><span class="comment"># maxmemory-policy 六种方式</span></span><br><span class="line"><span class="comment"># 1、volatile-lru：只对设置了过期时间的key进行LRU（默认值） </span></span><br><span class="line"><span class="comment"># 2、allkeys-lru ： 删除lru算法的key   </span></span><br><span class="line"><span class="comment"># 3、volatile-random：随机删除即将过期key   </span></span><br><span class="line"><span class="comment"># 4、allkeys-random：随机删除   </span></span><br><span class="line"><span class="comment"># 5、volatile-ttl ： 删除即将过期的   </span></span><br><span class="line"><span class="comment"># 6、noeviction ： 永不过期，返回错误</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>APPEND ONLY MODE aof 配置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">appendonly no	<span class="comment"># 默认是不开启aof模式的，默认使用rdb方式持久化，大部分情况下，rdb完全够用</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span>	<span class="comment"># 持久化的文件的名字</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># appendfsync always	# 每次修改都会sync，消耗性能</span></span><br><span class="line">appendfsync everysec	<span class="comment"># 每秒执行一次sync，可能会丢失这一秒的数据</span></span><br><span class="line"><span class="comment"># appendfsync no	# 不执行sync，操作系统自己同步数据，速度最快</span></span><br></pre></td></tr></table></figure>

<h1 id="redis-持久化"><a href="#redis-持久化" class="headerlink" title="redis 持久化"></a>redis 持久化</h1><p> redis 是内存数据库，如果不将内存中的数据保存到磁盘，那么一旦服务器进程退出，服务器中的数据也会丢失，所以 redis 提供了持久化功能！</p>
<h2 id="RDB（Redis-DataBase）"><a href="#RDB（Redis-DataBase）" class="headerlink" title="RDB（Redis DataBase）"></a>RDB（Redis DataBase）</h2><blockquote>
<p>什么是 RDB </p>
</blockquote>
<p>在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是行话讲的 Snapshot 快照，它恢复时是将快照中的文件直接读到内存中。</p>
<p>redis 会单独创建（fork）一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程不进行任何 IO 操作，这就确保了极高的性能。如果需要大规模数据的恢复，且对于数据恢复的完整性不是很敏感，那么 RDB 方式要比 ROF 方式更高效，RBD 的缺点就是最后一次持久化后的数据可能丢失，默认的就是 RDB，一般情况下不需要修改这个配置</p>
<p><img src="https://s2.loli.net/2023/07/22/QlJajgzvH2Kpe64.jpg" alt="image-20200711132619528"></p>
<p><span style='color: red'>rdb 保存的文件：dump.rdb</span></p>
<p><img src="https://s2.loli.net/2023/07/22/EiGPZwfmFXV82lI.jpg" alt="image-20200711125649417"></p>
<blockquote>
<p>触发机制</p>
</blockquote>
<ol>
<li><p>满足 save 规则时，会触发 rdb</p>
</li>
<li><p>执行 flushall，也会触发 rdb</p>
</li>
<li><p>退出 redis ，也会触发 rdb</p>
</li>
</ol>
<p><img src="https://s2.loli.net/2023/07/22/R3GJxpZg5rbh9Um.jpg" alt="image-20200711130325698"></p>
<blockquote>
<p>如何恢复 rdb 文件</p>
</blockquote>
<ol>
<li><p>只要将 rdb 文件放在 redis 启动目录中，redis 启动的时候就会自动检查 dump.rdb 恢复其中的数据</p>
</li>
<li><p>查看 rdb 文件存放位置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get <span class="built_in">dir</span></span><br><span class="line">1) <span class="string">&quot;dir&quot;</span></span><br><span class="line">2) <span class="string">&quot;/usr/local/bin&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<p>优点</p>
</blockquote>
<ol>
<li>适合大规模数据恢复</li>
<li>对数据完整性要求不高</li>
</ol>
<blockquote>
<p>缺点</p>
</blockquote>
<ol>
<li>需要一定时间间隔进行操作，如果 redis 意外宕机了，最后一次修改的数据就没有了</li>
<li>fork 进程时，会占用一定的内存空间</li>
</ol>
<h2 id="AOF（Append-Only-File）"><a href="#AOF（Append-Only-File）" class="headerlink" title="AOF（Append Only File）"></a>AOF（Append Only File）</h2><p>将所有写入的命令记录下来，恢复时将命令重新执行一遍</p>
<blockquote>
<p>AOF 是什么</p>
</blockquote>
<p> 以日志的形式记录每个写操作，将 redis 执行过的所有执行记录下来（读操作不记录），只许追加文件但不可以改写文件，redis 启动时会读取该文件重新构建数据。换言之，redis 重启就是根据日志文件的内容将指令从前往后执行一次，完成数据的恢复工作</p>
<p><span style='color: red'>AOF 保存的文件：appendonly.aof</span></p>
<p><img src="https://s2.loli.net/2023/07/22/h4K6rzOmcEdgXUS.jpg" alt="image-20200711133157744"></p>
<p>默认是不开启的，需要手动开启 <code>appendonly yes</code></p>
<p>重启 redis 即可生效</p>
<p><img src="https://s2.loli.net/2023/07/22/t3NGCHvdr71QmnY.jpg" alt="image-20200711133415125"></p>
<p>进入 redis 执行命令，然后关机退出</p>
<p><img src="https://s2.loli.net/2023/07/22/StcAegzBIXKDyRZ.jpg" alt="image-20200711133750974"></p>
<p>查看 appendonly.aof</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/bin/appendonly.aof</span><br></pre></td></tr></table></figure>

<img src="https://s2.loli.net/2023/07/22/FMYdx6APewlv2qn.jpg" alt="image-20200711133926344" style="zoom:50%;" />

<p>手动修改 appendpnly.aof ，故意破坏内容后再次启动 redis 发现启动失败</p>
<p><img src="https://s2.loli.net/2023/07/22/L5JYOMCmDFcW4ES.jpg" alt="image-20200711134153526"></p>
<p>Redis 提供一个工具，用来修复 aof 文件</p>
<p><img src="https://s2.loli.net/2023/07/22/37a5wNTZ8UAYIPe.jpg" alt="image-20200711134307591"></p>
<p>修复成功后，重新启动 redis，会发现数据已恢复</p>
<p><img src="https://s2.loli.net/2023/07/22/jkS3uJM2e6dVc5W.jpg" alt="image-20200711134600067"></p>
<p>但是发现，k3 的数据丢失了！</p>
<blockquote>
<p>优点</p>
</blockquote>
<ol>
<li><p>每一次修改都会同步，文件的完整性会更好</p>
</li>
<li><p>拥有不同的同步策略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">appendonly no	<span class="comment"># 默认是不开启aof模式的，默认使用rdb方式持久化，大部分情况下，rdb完全够用</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span>	<span class="comment"># 持久化的文件的名字</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># appendfsync always	# 每次修改都会sync，消耗性能</span></span><br><span class="line">appendfsync everysec	<span class="comment"># 每秒执行一次sync，可能会丢失这一秒的数据</span></span><br><span class="line"><span class="comment"># appendfsync no	# 不执行sync，操作系统自己同步数据，速度最快</span></span><br></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<p>缺点</p>
</blockquote>
<ol>
<li>aof 的数据文件远远大于 rdb，恢复速度很慢</li>
<li>运行效率也低于 rdb，所以 redis 默认是用 rdb 持久化</li>
</ol>
<blockquote>
<p>aof 文件的重新规则</p>
</blockquote>
<p>Aof 的规则就是无限追加，文件就会越来越大</p>
<p><img src="https://s2.loli.net/2023/07/22/XDLwSbNgIdok9Y6.jpg" alt="image-20200711135327328"></p>
<p>文件大于 64 M，就会 fork 一个新的进程重写文件</p>
<p><strong><span style='color: red'>RBD 和 ROF 的对比</span></strong></p>
<p><img src="https://s2.loli.net/2023/07/22/4BDyQcqPw7AVb82.jpg" alt="b5718f91883d9f0e90144e681d1c2ea7"></p>
<p><strong>扩展：</strong></p>
<ol>
<li>RDB 持久化方式能够在指定的时间间隔内对你的数据进行快照存储</li>
<li>AOF 持久化方式记录每次对服务器写的操作，当服务器重启时会重新执行这些命令来回复数据，AOF 命令以 Reids 协议追加保存每次写的操作到文件末尾（redis 还能对 aof 文件进行后台重写，使得 aof 文件的体积不至于过大）</li>
<li><span style='color: red'>如果只做缓存，只希望数据在服务器运行的时候存在，就不使用任何持久化</span></li>
<li>同时开启两种持久化方式<ol>
<li>这种情况下，当 redis 重启的时候会优先载入 aof 文件来恢复原始的数据，因为在通常的情况下 aof 文件保存的数据集要比 rdb 文件保存的数据集更加完整</li>
<li>rdb 的数据不实时，同时使用两者时服务器重启也会只找 aof 文件。那是不是只使用 aof 呢？建议不要，因为 rdb 更适合用于备份数据库（aof 在不断变化不好备份），快速重启，而且不会有 aof 可能潜在的bug，留着作为一个万一的手段</li>
</ol>
</li>
<li>性能建议<ol>
<li>因为 rdb 文件只用作备份用途，建议只在 slave 上持久化 rdb 文件，而且只要 15 分钟备份一次就够了，只保留 <code>save 900 1</code> 这条规则</li>
<li>如果开启 aof，好处是在最恶劣情况下丢失数据也不会超过两秒数据，启动脚本简单只需要 load 自己的 aof 文件即可。代价一是带来了持续的 IO，二是 aof rewrite 的最后将 rewrite 过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。只要硬盘许可，应该尽量减少 aof rewrite 的频率，aof rewrite 的基础大小默认值 64M 太小了，可以设置到 5G 以上，默认超过原大小 100% 重新可以改到适当的数值</li>
<li>如果不开启 aof，仅靠 Master-Slave Repllcation 实现高可用性也可以，能省掉一大笔 IO，也减少了 rewrite 时带来的系统波动。代价是如果 Master&#x2F;Slave 同时宕掉，会丢失十几分钟的数据，启动脚本也要比较两个 Master&#x2F;Slave 中的 rdb 文件，载入比较新的那一个，微博就是这种</li>
</ol>
</li>
</ol>
<h1 id="Redis-订阅发布"><a href="#Redis-订阅发布" class="headerlink" title="Redis 订阅发布"></a>Redis 订阅发布</h1><p>Redis 订阅发布（pub&#x2F;sub）是一种消息通信模式</p>
<p>发布者（pub）发送消息、订阅者（sub）接收消息</p>
<p>redis 一个客户端可以订阅任意数量的频道</p>
<p>订阅发布消息图：</p>
<p><img src="https://s2.loli.net/2023/07/22/wASZrPq13vkIOsx.jpg" alt="img"></p>
<p>下图展示了频道 channel1 ， 以及订阅这个频道的三个客户端 —— client2 、 client5 和 client1 之间的关系：</p>
<p><img src="https://s2.loli.net/2023/07/22/RJS5Miaxn8dXIQu.jpg" alt="img"></p>
<p>当有新消息通过 PUBLISH 命令发送给频道 channel1 时， 这个消息就会被发送给订阅它的三个客户端：</p>
<p><img src="https://s2.loli.net/2023/07/22/WleBNa6AGb8EFhL.jpg" alt="img"></p>
<blockquote>
<p>命令</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">序号</th>
<th align="left">命令及描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">[PSUBSCRIBE pattern <a target="_blank" rel="noopener" href="https://www.runoob.com/redis/pub-sub-psubscribe.html">pattern …]</a> 订阅一个或多个符合给定模式的频道。</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">[PUBSUB subcommand <a target="_blank" rel="noopener" href="https://www.runoob.com/redis/pub-sub-pubsub.html">argument [argument …]]</a> 查看订阅与发布系统状态。</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.runoob.com/redis/pub-sub-publish.html">PUBLISH channel message</a> 将信息发送到指定的频道。</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">[PUNSUBSCRIBE <a target="_blank" rel="noopener" href="https://www.runoob.com/redis/pub-sub-punsubscribe.html">pattern [pattern …]]</a> 退订所有给定模式的频道。</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">[SUBSCRIBE channel <a target="_blank" rel="noopener" href="https://www.runoob.com/redis/pub-sub-subscribe.html">channel …]</a> 订阅给定的一个或多个频道的信息。</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left">[UNSUBSCRIBE <a target="_blank" rel="noopener" href="https://www.runoob.com/redis/pub-sub-unsubscribe.html">channel [channel …]]</a> 指退订给定的频道。</td>
</tr>
</tbody></table>
<blockquote>
<p>测试</p>
</blockquote>
<p>订阅端：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SUBSCRIBE star					<span class="comment"># 订阅一个频道 star</span></span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) <span class="string">&quot;subscribe&quot;</span></span><br><span class="line">2) <span class="string">&quot;star&quot;</span></span><br><span class="line">3) (<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待读取信息</span></span><br><span class="line">1) <span class="string">&quot;message&quot;</span>		<span class="comment"># 消息</span></span><br><span class="line">2) <span class="string">&quot;star&quot;</span>			<span class="comment"># 频道</span></span><br><span class="line">3) <span class="string">&quot;liuyifei&quot;</span>		<span class="comment"># 消息具体内容</span></span><br><span class="line">1) <span class="string">&quot;message&quot;</span></span><br><span class="line">2) <span class="string">&quot;star&quot;</span></span><br><span class="line">3) <span class="string">&quot;dilireba&quot;</span></span><br></pre></td></tr></table></figure>

<p>发送端：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PUBLISH star <span class="string">&quot;liuyifei&quot;</span>			<span class="comment"># 发布者发布消息到指定频道</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PUBLISH star <span class="string">&quot;dilireba&quot;</span>			<span class="comment"># 发布者发布消息到指定频道</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>原理</p>
</blockquote>
<p>通过 SUBSCRIBE 命令订阅某频道后，redis-server 里维护了一个字典，字典的键就是一个个的 channel，而字典的值则是一个链表，链表保存了所有订阅这个 channel 的客户端，SUBSCRIBE 命令的关键，就是将客户端添加到给定 channel 的订阅链表中</p>
<p>通过 PUBLISH 命令向订阅者发送消息，redis-server 会使用给定的 channel 作为键，在它维护的字典中查找记录了订阅这个 channel 的所有客户端的链表，遍历这个链表，将消息发布给所有订阅者</p>
<p>Pub&#x2F;Sub 从字面上理解就是发布（Publish）和订阅（Subscribe），在 Redis 中，你可以设定对某一个 key 值进行消息发布及消息订阅，当一个 key 值进行消息发布后，所有订阅它的客户端都会收到对应的消息。这一功能最明显的用法就是用作实时消息系统，比如普通的即时聊天、群聊等</p>
<p><img src="https://s2.loli.net/2023/07/22/cTtUoKWrOlEpBug.jpg" alt="image-20200711150129632"></p>
<h1 id="Redis-主从复制"><a href="#Redis-主从复制" class="headerlink" title="Redis 主从复制"></a>Redis 主从复制</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>主从复制，是指将一台 Redis 服务器的数据，复制到其他的 Redis 服务器。前者称为主节点（master），后者称为从节点（slave）。<span style='color: red'>数据的复制是单向的，只能由主节点到从节点</span>。Master 以写为主，Slave 以读为主</p>
<p><span style='color: red'>默认情况下，每台 Redis 服务器都是主节点</span></p>
<p>一个主节点可以有多个从节点（或没有从节点），但一个从节点只能有一个主节点</p>
<p><strong>主从复制的作用主要包括：</strong></p>
<ul>
<li>数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。</li>
<li>故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。</li>
<li>负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis 数据时应用连接主节点，读 Redis 数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高 Redis 服务器的并发量。</li>
<li>高可用（集群）基石：主从复制还是哨兵和集群能够实施的基础，因此说主从复制是 Redis 高可用的基础。</li>
</ul>
<p>一般来说，要将 Redis 运用于工程项目中，只使用一台 Redis 是万万不能的，原因如下：</p>
<ol>
<li>从结构上，单个 Redis 服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力较大</li>
<li>从容量上，单个 Redis 服务器内存容量有限，就算一台 Redis 服务器内容容量为 256G，也不能将所有内容用作 Redis 存储内存，一般来说，单台 Redis 最大使用内存不应该超过20G</li>
</ol>
<blockquote>
<p>电商网站上的商品，一般都是一次上传，无数次浏览，多读少写</p>
</blockquote>
<p>对于这种场景，使用如下架构：</p>
<p><img src="https://s2.loli.net/2023/07/22/gDujSvqzpXTZHMn.jpg" alt="image-20200711151637321"></p>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>只配置从库，不用配置主库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication		<span class="comment"># 查看当前库信息</span></span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master								<span class="comment"># 角色：主机</span></span><br><span class="line">connected_slaves:0						<span class="comment"># 连接的从库数量：0</span></span><br><span class="line">master_replid:b2f799e62d946ebb93873e5dae635337433fecd6</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p>复制配置文件进行修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost config]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/bin/config</span><br><span class="line">[root@localhost config]<span class="comment"># ll</span></span><br><span class="line">total 336</span><br><span class="line">-rw-r--r--. 1 root root 82658 Jul 10 08:32 redis6379.conf</span><br><span class="line">-rw-r--r--. 1 root root 82658 Jul 10 08:33 redis6380.conf</span><br><span class="line">-rw-r--r--. 1 root root 82658 Jul 10 08:35 redis6381.conf</span><br><span class="line">-rw-r--r--. 1 root root 82646 Jul 10 06:47 redis.conf</span><br><span class="line">[root@localhost config]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>修改 redis6379.conf、redis6380.conf、redis6381.conf</p>
<ol>
<li>端口</li>
<li>pid 文件</li>
<li>log 文件名字 logfile</li>
<li>dump.db 文件名字 dbfilename</li>
</ol>
<p>依次使用这三个配置文件，启动三个服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]<span class="comment"># ./redis-server config/redis6379.conf</span></span><br><span class="line">[root@localhost bin]<span class="comment"># ./redis-server config/redis6380.conf</span></span><br><span class="line">[root@localhost bin]<span class="comment"># ./redis-server config/redis6381.conf</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/07/22/6iu1G8sEgHro5Cm.jpg" alt="image-20200711153712383"></p>
<p>分别连接三个服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 6379</span></span><br><span class="line">[root@localhost bin]<span class="comment"># ./redis-cli -p 6379</span></span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:b2f799e62d946ebb93873e5dae635337433fecd6</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6380</span></span><br><span class="line">[root@localhost bin]<span class="comment"># ./redis-cli -p 6380</span></span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:16ec0af43a4a5298c2fe49d925647fb1f86e670f</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line">127.0.0.1:6380&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6381</span></span><br><span class="line">[root@localhost bin]<span class="comment"># ./redis-cli -p 6381</span></span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:85dc09574791d7773085c83463bcb4338093252b</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line">127.0.0.1:6381&gt;</span><br></pre></td></tr></table></figure>

<h2 id="一主二从"><a href="#一主二从" class="headerlink" title="一主二从"></a>一主二从</h2><p><span style='color: red'>默认情况下，每台 redis 服务器都是主节点</span>，所以只用配置从机就好了</p>
<p>我们使用 6379 端口的作为主机，6380、6381 作为从机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 6380 端口的客户端进行配置</span></span><br><span class="line">127.0.0.1:6380&gt; SLAVEOF 127.0.0.1 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave				<span class="comment"># 当前角色为从机</span></span><br><span class="line">master_host:127.0.0.1	<span class="comment"># 主机的地址</span></span><br><span class="line">master_port:6379		<span class="comment"># 主机的端口</span></span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:5</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:14</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:f9577f9528ab15f137d134365fb44acf24336789</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:14</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:14</span><br><span class="line">127.0.0.1:6380&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看主机此时的状态</span></span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1		<span class="comment"># 已连接的从机数量：1</span></span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=42,lag=1  <span class="comment"># 第1个从机的信息</span></span><br><span class="line">master_replid:f9577f9528ab15f137d134365fb44acf24336789</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:42</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:42</span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 6381 端口的客户端进行配置</span></span><br><span class="line">127.0.0.1:6381&gt; SLAVEOF 127.0.0.1 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:5</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:280</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:f9577f9528ab15f137d134365fb44acf24336789</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:280</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:281</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line">127.0.0.1:6381&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看主机此时的状态</span></span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2		<span class="comment"># 已连接的从机数量：2</span></span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=364,lag=0		<span class="comment"># 第1个从机的信息</span></span><br><span class="line">slave1:ip=127.0.0.1,port=6381,state=online,offset=364,lag=1		<span class="comment"># 第2个从机的信息</span></span><br><span class="line">master_replid:f9577f9528ab15f137d134365fb44acf24336789</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:364</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:364</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p>真实的主从配置应该从配置文件中配置，我们这里使用命令进行配置，只是暂时的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################# REPLICATION #################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Master-Replica replication. Use replicaof to make a Redis instance a copy of</span></span><br><span class="line"><span class="comment"># another Redis server. A few things to understand ASAP about Redis replication.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   +------------------+      +---------------+</span></span><br><span class="line"><span class="comment">#   |      Master      | ---&gt; |    Replica    |</span></span><br><span class="line"><span class="comment">#   | (receive writes) |      |  (exact copy) |</span></span><br><span class="line"><span class="comment">#   +------------------+      +---------------+</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1) Redis replication is asynchronous, but you can configure a master to</span></span><br><span class="line"><span class="comment">#    stop accepting writes if it appears to be not connected with at least</span></span><br><span class="line"><span class="comment">#    a given number of replicas.</span></span><br><span class="line"><span class="comment"># 2) Redis replicas are able to perform a partial resynchronization with the</span></span><br><span class="line"><span class="comment">#    master if the replication link is lost for a relatively small amount of</span></span><br><span class="line"><span class="comment">#    time. You may want to configure the replication backlog size (see the next</span></span><br><span class="line"><span class="comment">#    sections of this file) with a sensible value depending on your needs.</span></span><br><span class="line"><span class="comment"># 3) Replication is automatic and does not need user intervention. After a</span></span><br><span class="line"><span class="comment">#    network partition replicas automatically try to reconnect to masters</span></span><br><span class="line"><span class="comment">#    and resynchronize with them.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># replicaof &lt;masterip&gt; &lt;masterport&gt;		修改此处的地址和端口</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>细节</p>
</blockquote>
<p>主机可以读写，从机只能读，主机中的所有信息和数据，都会同步到从机</p>
<p>主机写：</p>
<p><img src="https://s2.loli.net/2023/07/22/8mzgQJpsbeMHVaO.jpg" alt="image-20200711155413665"></p>
<p>从机读：</p>
<p><img src="https://s2.loli.net/2023/07/22/pwMACrWtTjVihKO.jpg" alt="image-20200711155450395"></p>
<p>测试：主机断开连接，从机是依旧链接到主机的，当主机重连时，从机依旧可以连接到主机</p>
<p>如果使用命令行配置主从，从机断开连接重新连接后，默认又会变回成主机的状态，再次配置为从机后，立马会将主机的数据同步过来</p>
<blockquote>
<p>复制原理</p>
</blockquote>
<p>Slave 启动成功连接到 Master 后会发送一个 sync 同步命令</p>
<p>Master 接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕后，<span style='color: red'>Master 将传送整个数据文件到 Slave，并完成一次完全同步</span></p>
<ul>
<li>全量复制：Slave 服务在接受到数据文件数据后， 将其存盘并加载到内存中</li>
<li>增量复制：Master 继续将所有收集到的修改命令依次传给 Slave，完成同步</li>
</ul>
<p><span style='color: red'>当 Slave 第一次连接或重新连接到 Master 时，一次完全同步（全量复制）将被自动执行</span></p>
<blockquote>
<p>层层链路</p>
</blockquote>
<p> <img src="https://s2.loli.net/2023/07/22/deJo9apmn1HijAq.jpg" alt="image-20200711163750846"></p>
<p>也可以实现主从复制</p>
<blockquote>
<p>当 Master 断开连接，是否可以选择一台 Slave 作为新的 Master</p>
</blockquote>
<p>当主机断开连接时，使用 <code>SLAVEOF no one</code> 设置从机成为新的主机，其他从机就可以连接新的主机了（手动）</p>
<h2 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h2><blockquote>
<p>概述</p>
</blockquote>
<p>当主机宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费时费力，还会造成一段时间内服务不可用。这不是一种推荐的方式，更多时候我们优先考虑哨兵模式，Redis 从 2.8 就开始正式提供了 Sentinel （哨兵）架构来解决这个问题。</p>
<p>哨兵模式是一种特殊的模式，首先 Redis 提供了哨兵的命令，哨兵是一个独立运行的进程，其原理是<strong>哨兵通过发送命了，等待 Redis 服务器响应，从而监控运行的多个 Redis 实例</strong></p>
<p><img src="https://s2.loli.net/2023/07/22/HkGeNlZjPVAnDiw.jpg" alt="image-20200711170809458"></p>
<p>哨兵的两个作用</p>
<ul>
<li>通过发送命令，让 Redis 服务器返回信息，监控其运行状态，包括主服务器和从服务器</li>
<li>当哨兵检测到 Master 宕机，会自动将 Slave 切换成 Matser，然后通过<strong>订阅发布模式</strong>通知其他从服务器，修改配置文件，使从服务器重新绑定主服务器</li>
</ul>
<p>然后一个哨兵进程对多个 Redis 服务器进行监控，可能会出现问题，为此，我们使用多个哨兵进行监控，各个哨兵之间还会进行互相监控，这样就形成了多哨兵模式   </p>
<p><img src="https://s2.loli.net/2023/07/22/pgaPBA4kCY7jOMw.jpg" alt="image-20200711173023514"></p>
<p>假设主服务器宕机，哨兵 1 先检测到这个结果，系统不会马上进行 failover 过程，仅仅是哨兵 1 主观的认为主服务器不可用，最个现象称为<strong>主观下线</strong>。当后面的哨兵也检测到主服务器不可用，且数量达到一定值的时候，哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行 failover（故障转移）的操作。切换成功后，通过订阅发布模式，由各个哨兵将自己监控的服务器切换主机，这个过程称为<strong>客观下线</strong></p>
<blockquote>
<p>测试</p>
</blockquote>
<p>目前的状态是一主二从（6379 主机、6380、6381从机）</p>
<p>1、配置哨兵配置文件 sentinel.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最基本的配置</span></span><br><span class="line"><span class="comment"># sentinel monitor 被监控的名称 host port 1</span></span><br><span class="line">sentinel monitor myredis 127.0.0.1 6379 1</span><br></pre></td></tr></table></figure>

<p>后面数字1，代表主机挂了，进行投票看让哪一台 slave 接替成为主机，票高者当选</p>
<p>2、启动哨兵</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]<span class="comment"># ./redis-sentinel config/sentinel.conf</span></span><br><span class="line">9761:X 10 Jul 2020 10:53:43.059 <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line">9761:X 10 Jul 2020 10:53:43.059 <span class="comment"># Redis version=6.0.5, bits=64, commit=00000000, modified=0, pid=9761, just started</span></span><br><span class="line">9761:X 10 Jul 2020 10:53:43.059 <span class="comment"># Configuration loaded</span></span><br><span class="line">9761:X 10 Jul 2020 10:53:43.060 * Increased maximum number of open files to 10032 (it was originally <span class="built_in">set</span> to 1024).</span><br><span class="line">                _._</span><br><span class="line">           _.-``__ <span class="string">&#x27;&#x27;</span>-._</span><br><span class="line">      _.-``    `.  `_.  <span class="string">&#x27;&#x27;</span>-._           Redis 6.0.5 (00000000/0) 64 bit</span><br><span class="line">  .-`` .-```.  ```\/    _.,_ <span class="string">&#x27;&#x27;</span>-._</span><br><span class="line"> (    <span class="string">&#x27;      ,       .-`  | `,    )     Running in sentinel mode</span></span><br><span class="line"><span class="string"> |`-._`-...-` __...-.``-._|&#x27;</span>` _.-<span class="string">&#x27;|     Port: 26379</span></span><br><span class="line"><span class="string"> |    `-._   `._    /     _.-&#x27;</span>    |     PID: 9761</span><br><span class="line">  `-._    `-._  `-./  _.-<span class="string">&#x27;    _.-&#x27;</span></span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>_.-<span class="string">&#x27;|</span></span><br><span class="line"><span class="string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="string">&#x27;    |           http://redis.io</span></span><br><span class="line"><span class="string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="string">&#x27;    _.-&#x27;</span></span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>_.-<span class="string">&#x27;|</span></span><br><span class="line"><span class="string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="string">&#x27;    |</span></span><br><span class="line"><span class="string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="string">&#x27;    _.-&#x27;</span></span><br><span class="line">      `-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span></span><br><span class="line">          `-._        _.-<span class="string">&#x27;</span></span><br><span class="line"><span class="string">              `-.__.-&#x27;</span></span><br><span class="line"></span><br><span class="line">9761:X 10 Jul 2020 10:53:43.061 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></span><br><span class="line">9761:X 10 Jul 2020 10:53:43.067 <span class="comment"># Sentinel ID is 84e5276c728e9cb61bb41f66b4a146c9e5b46c2a</span></span><br><span class="line">9761:X 10 Jul 2020 10:53:43.067 <span class="comment"># +monitor master myredis 127.0.0.1 6379 quorum 1</span></span><br><span class="line">9761:X 10 Jul 2020 10:53:43.069 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ myredis 127.0.0.1 6379</span><br><span class="line">9761:X 10 Jul 2020 10:53:43.075 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ myredis 127.0.0.1 6379</span><br></pre></td></tr></table></figure>

<p>如果此时主机宕机，哨兵会从从机中选择一台服务器成为新的主机（投票算法）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">9761:X 10 Jul 2020 10:56:39.583 <span class="comment"># +sdown master myredis 127.0.0.1 6379</span></span><br><span class="line">9761:X 10 Jul 2020 10:56:39.583 <span class="comment"># +odown master myredis 127.0.0.1 6379 #quorum 1/1</span></span><br><span class="line">9761:X 10 Jul 2020 10:56:39.584 <span class="comment"># +new-epoch 1</span></span><br><span class="line">9761:X 10 Jul 2020 10:56:39.584 <span class="comment"># +try-failover master myredis 127.0.0.1 6379</span></span><br><span class="line">9761:X 10 Jul 2020 10:56:39.590 <span class="comment"># +vote-for-leader 84e5276c728e9cb61bb41f66b4a146c9e5b46c2a 1</span></span><br><span class="line">9761:X 10 Jul 2020 10:56:39.590 <span class="comment"># +elected-leader master myredis 127.0.0.1 6379</span></span><br><span class="line">9761:X 10 Jul 2020 10:56:39.590 <span class="comment"># +failover-state-select-slave master myredis 127.0.0.1 6379</span></span><br><span class="line">9761:X 10 Jul 2020 10:56:39.660 <span class="comment"># +selected-slave slave 127.0.0.1:6381 127.0.0.1 6381 @ myredis 127.0.0.1 6379</span></span><br><span class="line">9761:X 10 Jul 2020 10:56:39.660 * +failover-state-send-slaveof-noone slave 127.0.0.1:6381 127.0.0.1 6381 @ myredis 127.0.0.1 6379</span><br><span class="line">9761:X 10 Jul 2020 10:56:39.739 * +failover-state-wait-promotion slave 127.0.0.1:6381 127.0.0.1 6381 @ myredis 127.0.0.1 6379</span><br><span class="line">9761:X 10 Jul 2020 10:56:39.858 <span class="comment"># +promoted-slave slave 127.0.0.1:6381 127.0.0.1 6381 @ myredis 127.0.0.1 6379</span></span><br><span class="line">9761:X 10 Jul 2020 10:56:39.858 <span class="comment"># +failover-state-reconf-slaves master myredis 127.0.0.1 6379</span></span><br><span class="line">9761:X 10 Jul 2020 10:56:39.921 * +slave-reconf-sent slave 127.0.0.1:6380 127.0.0.1 6380 @ myredis 127.0.0.1 6379</span><br><span class="line">9761:X 10 Jul 2020 10:56:40.890 * +slave-reconf-inprog slave 127.0.0.1:6380 127.0.0.1 6380 @ myredis 127.0.0.1 6379</span><br><span class="line">9761:X 10 Jul 2020 10:56:40.890 * +slave-reconf-done slave 127.0.0.1:6380 127.0.0.1 6380 @ myredis 127.0.0.1 6379</span><br><span class="line">9761:X 10 Jul 2020 10:56:40.993 <span class="comment"># +failover-end master myredis 127.0.0.1 6379</span></span><br><span class="line">9761:X 10 Jul 2020 10:56:40.993 <span class="comment"># +switch-master myredis 127.0.0.1 6379 127.0.0.1 6381</span></span><br><span class="line">9761:X 10 Jul 2020 10:56:40.993 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ myredis 127.0.0.1 6381</span><br><span class="line">9761:X 10 Jul 2020 10:56:40.993 * +slave slave 127.0.0.1:6379 127.0.0.1 6379 @ myredis 127.0.0.1 6381</span><br><span class="line">9761:X 10 Jul 2020 10:57:11.030 <span class="comment"># +sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ myredis 127.0.0.1 6381</span></span><br></pre></td></tr></table></figure>

<p>可以看到 6381 成为了主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=19800,lag=1</span><br><span class="line">master_replid:1610d6694c340595a8713a46ccd630deadbf3fda</span><br><span class="line">master_replid2:6aaa92137ca176c42b8138eea5a3f18714b63916</span><br><span class="line">master_repl_offset:19932</span><br><span class="line">second_repl_offset:18298</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1220</span><br><span class="line">repl_backlog_histlen:18713</span><br><span class="line">127.0.0.1:6381&gt;</span><br></pre></td></tr></table></figure>

<p>此时之前宕掉的主机重新连接后，只能归到新的主机成为从机，再次查看 6381</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=42197,lag=0</span><br><span class="line">slave1:ip=127.0.0.1,port=6379,state=online,offset=42197,lag=1</span><br><span class="line">master_replid:1610d6694c340595a8713a46ccd630deadbf3fda</span><br><span class="line">master_replid2:6aaa92137ca176c42b8138eea5a3f18714b63916</span><br><span class="line">master_repl_offset:42197</span><br><span class="line">second_repl_offset:18298</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1220</span><br><span class="line">repl_backlog_histlen:40978</span><br><span class="line">127.0.0.1:6381&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>优缺点</p>
</blockquote>
<p>优点：</p>
<ol>
<li>哨兵集群，基于主从复制模式，所有主从配置的有点，它全有</li>
<li>主从可以切换，故障可以转移，系统的可用性更好</li>
<li>哨兵模式是主从模式的升级，手动到自动，更加健壮</li>
</ol>
<p>缺点：</p>
<ol>
<li>Redis 不好在线扩容，集群容量一旦达到上限，在线扩容就十分麻烦</li>
<li>哨兵模式的配置比较麻烦，很多的配置项</li>
</ol>
<blockquote>
<p>哨兵模式的全部配置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example sentinel.conf  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 哨兵sentinel实例运行的端口 默认26379  </span></span><br><span class="line">port 26379  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 哨兵sentinel的工作目录  </span></span><br><span class="line"><span class="built_in">dir</span> /tmp  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 哨兵sentinel监控的redis主节点的 ip port   </span></span><br><span class="line"><span class="comment"># master-name  可以自己命名的主节点名字 只能由字母A-z、数字0-9 、这三个字符&quot;.-_&quot;组成。  </span></span><br><span class="line"><span class="comment"># quorum 当这些quorum个数sentinel哨兵认为master主节点失联 那么这时 客观上认为主节点失联了  </span></span><br><span class="line"><span class="comment"># sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;  </span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 当在Redis实例中开启了requirepass foobared 授权密码 这样所有连接Redis实例的客户端都要提供密码  </span></span><br><span class="line"><span class="comment"># 设置哨兵sentinel 连接主从的密码 注意必须为主从设置一样的验证密码  </span></span><br><span class="line"><span class="comment"># sentinel auth-pass &lt;master-name&gt; &lt;password&gt;  </span></span><br><span class="line">sentinel auth-pass mymaster MySUPER--secret-0123passw0rd  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 指定多少毫秒之后 主节点没有应答哨兵sentinel 此时 哨兵主观上认为主节点下线 默认30秒  </span></span><br><span class="line"><span class="comment"># sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;  </span></span><br><span class="line">sentinel down-after-milliseconds mymaster 30000  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 这个配置项指定了在发生failover主备切换时最多可以有多少个slave同时对新的master进行 同步，  </span></span><br><span class="line"><span class="comment"># 这个数字越小，完成failover所需的时间就越长，  </span></span><br><span class="line"><span class="comment"># 但是如果这个数字越大，就意味着越 多的slave因为replication而不可用。  </span></span><br><span class="line"><span class="comment"># 可以通过将这个值设为 1 来保证每次只有一个slave 处于不能处理命令请求的状态。  </span></span><br><span class="line"><span class="comment"># sentinel parallel-syncs &lt;master-name&gt; &lt;numslaves&gt;  </span></span><br><span class="line">sentinel parallel-syncs mymaster 1  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 故障转移的超时时间 failover-timeout 可以用在以下这些方面：   </span></span><br><span class="line"><span class="comment">#1. 同一个sentinel对同一个master两次failover之间的间隔时间。  </span></span><br><span class="line"><span class="comment">#2. 当一个slave从一个错误的master那里同步数据开始计算时间。直到slave被纠正为向正确的master那里同步数据时。  </span></span><br><span class="line"><span class="comment">#3.当想要取消一个正在进行的failover所需要的时间。    </span></span><br><span class="line"><span class="comment">#4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来了  </span></span><br><span class="line"><span class="comment"># 默认三分钟  </span></span><br><span class="line"><span class="comment"># sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;  </span></span><br><span class="line">sentinel failover-timeout mymaster 180000  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># SCRIPTS EXECUTION  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员。  </span></span><br><span class="line"><span class="comment"># 对于脚本的运行结果有以下规则：  </span></span><br><span class="line"><span class="comment"># 若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10  </span></span><br><span class="line"><span class="comment"># 若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行。  </span></span><br><span class="line"><span class="comment"># 如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同。  </span></span><br><span class="line"><span class="comment"># 一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行。  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 通知型脚本:当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本，  </span></span><br><span class="line"><span class="comment"># 这时这个脚本应该通过邮件，SMS等方式去通知系统管理员关于系统不正常运行的信息。调用该脚本时，将传给脚本两个参数，  </span></span><br><span class="line"><span class="comment"># 一个是事件的类型，  </span></span><br><span class="line"><span class="comment"># 一个是事件的描述。  </span></span><br><span class="line"><span class="comment"># 如果sentinel.conf配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则sentinel无法正常启动成功。  </span></span><br><span class="line"><span class="comment"># 通知脚本  </span></span><br><span class="line"><span class="comment"># sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;  </span></span><br><span class="line">sentinel notification-script mymaster /var/redis/notify.sh  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 客户端重新配置主节点参数脚本  </span></span><br><span class="line"><span class="comment"># 当一个master由于failover而发生改变时，这个脚本将会被调用，通知相关的客户端关于master地址已经发生改变的信息。  </span></span><br><span class="line"><span class="comment"># 以下参数将会在调用脚本时传给脚本:  </span></span><br><span class="line"><span class="comment"># &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;  </span></span><br><span class="line"><span class="comment"># 目前&lt;state&gt;总是“failover”,  </span></span><br><span class="line"><span class="comment"># &lt;role&gt;是“leader”或者“observer”中的一个。   </span></span><br><span class="line"><span class="comment"># 参数 from-ip, from-port, to-ip, to-port是用来和旧的master和新的master(即旧的slave)通信的  </span></span><br><span class="line"><span class="comment"># 这个脚本应该是通用的，能被多次调用，不是针对性的。  </span></span><br><span class="line"><span class="comment"># sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;  </span></span><br><span class="line">sentinel client-reconfig-script mymaster /var/redis/reconfig.sh		<span class="comment"># 一般运维来进行配置</span></span><br></pre></td></tr></table></figure>

<h1 id="Redis-缓存穿透和雪崩"><a href="#Redis-缓存穿透和雪崩" class="headerlink" title="Redis 缓存穿透和雪崩"></a>Redis 缓存穿透和雪崩</h1><p>Redis 缓存的使用，极大的提升了应用程序的性能和效率，特别是数据查询方面。但同时，它也带来了一些问题，其中最要害的问题，就是数据一致性的问题，从严格意义上讲，此问题无解。如果对数据的一致性要求很高，那么就不能使用缓存。</p>
<p>另外一些典型的问题比如：缓存穿透、缓存雪崩和缓存击穿。目前业界都有比较流行的解决方案</p>
<h2 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h2><blockquote>
<p>概念</p>
</blockquote>
<p>缓存穿透的概念很简单，客户端发起请求查询一个数据，发现 redis 内存数据库中没有，也就是缓存没有命中，于是向持久层数据库发起查询，发现也没有，查询失败。当用户很多的时候回，大量缓存没有命中，于是都去请求了持久层数据库，这样就给持久层数据库造成了跟大的压力，这时候就相当于出现了缓存穿透</p>
<p><img src="https://s2.loli.net/2023/07/22/1su2hLcmVGFyedC.jpg" alt="image-20200711180527831"></p>
<blockquote>
<p>解决方案</p>
</blockquote>
<p><strong>布隆过滤器</strong></p>
<p>布隆过滤器是一种概率型数据结构，对所有可能查询的参数以 hash 形式存储，在控制层先进行校验，不符合则丢弃，从而避免了对底层存储系统的压力。</p>
<p>相比于传统的 List、Set、Map 等数据结构，它更高效、占用空间更少，但是缺点是其返回的结果是概率性的，而不是确切的</p>
<p>原理：</p>
<p>布隆过滤器是一个叫“布隆”的人提出的，它本身是一个很长的二进制向量，既然是二进制的向量，那么显而易见的，存放的不是 0 ，就是 1。</p>
<p>现在我们新建一个长度为 8 的布隆过滤器，默认值都是 0，就像下面这样：</p>
<p><img src="https://s2.loli.net/2023/07/22/RhQ6XvrqHgZumaE.jpg" alt="image-20200711190316300"></p>
<p>现在我们添加 2008 这个数据，先通过三种不同的计算方式（hash1、hash2、hash3）得到三个数字</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hash1(<span class="string">&#x27;2008&#x27;</span>) = 1;</span><br><span class="line">hash2(<span class="string">&#x27;2008&#x27;</span>) = 4;</span><br><span class="line">hash3(<span class="string">&#x27;2008&#x27;</span>) = 6;</span><br></pre></td></tr></table></figure>

<p>将得到的三个数字，填充至创建的布隆过滤器</p>
<p><img src="https://s2.loli.net/2023/07/22/agGyxwJzTHDrvqP.jpg" alt="image-20200711183921339"></p>
<p>添加 2020 这个数据，先通过三种不同的计算方式（hash1、hash2、hash3）得到三个数字</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hash1(<span class="string">&#x27;2020&#x27;</span>) = 2;</span><br><span class="line">hash2(<span class="string">&#x27;2020&#x27;</span>) = 4;</span><br><span class="line">hash3(<span class="string">&#x27;2020&#x27;</span>) = 7;</span><br></pre></td></tr></table></figure>

<p>将得到的三个数字，填充至创建的布隆过滤器</p>
<p><img src="https://s2.loli.net/2023/07/22/ZSqCW1iKNzloVuY.jpg" alt="image-20200711184404398"></p>
<p>可以看出，仅仅从布隆过滤器本身而言，根本没有存放完整的数据，只是运用一系列随机映射函数计算出位置，然后填充二进制向量。</p>
<p>值得注意的是，4 这个 bit 位由于两个值的哈希函数都返回了这个 bit 位，因此它被覆盖了。现在我们如果想查询 “2022” 这个值是否存在，哈希函数返回了 1、4、8 三个值，结果我们发现 8 这个 bit 位上的值为 0，说明没有任何一个值映射到这个 bit 位上，因此我们可以很确定地说 “2020” 这个值不存在。而当我们需要查询 “2006” 这个值是否存在的话，假设哈希函数返回 1、4、7，然后我们检查发现这三个 bit 位上的值均为 1，那么我们可以说 “2006” 存在了么？答案是不可以，只能是 “2006” 这个值可能存在。</p>
<p>这是为什么呢？答案跟简单，因为随着增加的值越来越多，被置为 1 的 bit 位也会越来越多，这样某个值 “2006” 即使没有被存储过，但是万一哈希函数返回的三个 bit 位都被其他值置位了 1 ，那么程序还是会判断 “2006” 这个值存在。</p>
<p>也就是说布隆过滤器只能判断数据是否一定不存在，而无法判断数据是否一定存在。</p>
<p>遗憾的是布隆过滤器是很难做到删除数据的</p>
<p>所以：</p>
<ul>
<li>优点：由于存放的不是完整的数据，所以占用的内存很少，而且新增，查询速度够快</li>
<li>缺点： 随着数据的增加，误判率随之增加；无法做到删除数据；只能判断数据是否一定不存在，而无法判断数据是否一定存在</li>
</ul>
<p><strong>缓存空对象</strong></p>
<p>当存储层不命中后，即时返回空对象也要缓存起来，同时设置一个过期时间，之后在访问这个数据将会从缓存中获取，保护了后端数据源</p>
<p>但这个方法存在两个问题：</p>
<ol>
<li>当空值被缓存起来时，这就意味这缓存需要更多的空间存储更多的键，因为这当中可能包含很多空值的键</li>
<li>即使对空值设置了过期时间，还是会存在缓存层和存储层的数据有一段时间的不一致，这个对于需要保持数据一致性的业务会有很大影响</li>
</ol>
<h2 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h2><blockquote>
<p>概述</p>
</blockquote>
<p>这里需要注意和缓存穿透的区别，缓存击穿是指一个 key 非常热点，在不停的扛着大并发集中对着一个点进行访问。当这个 key 在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个屏障上凿开了一个洞。</p>
<p>在某个 key 在过期的瞬间，有大量的请求并发访问，这类数据一般是热点数据，由于缓存过期，会同时访问数据库来查询最新数据，并且回写缓存，会导致数据库瞬间压力过大（微博宕机）</p>
<blockquote>
<p>解决方案</p>
</blockquote>
<p><strong>设置缓存永不过期</strong></p>
<p>如果缓存永不过期，就肯定不会出现被击穿的可能</p>
<p><strong>加互斥锁</strong></p>
<p>使用分布式锁，保证对于每个 key 同时只有一个线程去查询后端服务，其他线程没有获得分布式锁的权限，因此只需等待即可，这种方式将高并发的压力转移到了分布式锁，因此对分布式锁的考验很大</p>
<p><img src="https://s2.loli.net/2023/07/22/4mZuPYezSo8JM5T.jpg" alt="image-20200711190633421"></p>
<h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><blockquote>
<p>概念</p>
</blockquote>
<p>缓存雪崩，是指在某一段时间，缓存集中过期失效，或者 redis 宕机</p>
<p>当缓存集中过期或服务宕机时，所有请求到达存储层，也会造成存储层压力过大</p>
<p>集中过期不是非常致命，比较致命的缓存雪崩是缓存服务器再某个节点断网或宕机。因为自然形成的缓存雪崩，一定是在某个时间段内的，这个时候数据库也是可以抗住压力的，无非就是对数据库产生周期性的压力而已。而缓存服务器宕机，对数据库服务器造成的压力是不可预知的，有可能瞬间就压垮数据库服务器</p>
<blockquote>
<p>解决方案</p>
</blockquote>
<p><strong>redis 高可用</strong></p>
<p>这个思想是多增设几台 redis ，这样一台挂掉其他的还可以继续工作，其实就是集群的概念</p>
<p><strong>限流降级</strong></p>
<p>在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量，比如对某个 key 只允许一个线程查询数据和写缓存，其他线程等待</p>
<p><strong>数据预热</strong></p>
<p>数据预热的含义是在正式部署前，先把可能的数据都预先访问一遍，这样部分可能大量访问的数据就会加载到缓存中，在即将发生大并发访问前手动触发加载缓存不同的 key，设置不同的过期时间，让缓存失效的时间点尽量均匀</p>
<blockquote>
<blockquote>
<p>该笔记整理与 B 站 up 主：狂神说Java </p>
<p>完整视频地址： <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1S54y1R7SB">https://www.bilibili.com/video/BV1S54y1R7SB</a></p>
<p>感谢狂神！</p>
</blockquote>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:zhangjiawang99@gmail.com">Mr.Want</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhangjiawang.github.io/2020/07/11/Redis/">https://zhangjiawang.github.io/2020/07/11/Redis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhangjiawang.github.io" target="_blank">Mr.Wantの博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/redis/">redis</a><a class="post-meta__tags" href="/tags/%E7%BC%93%E5%AD%98/">缓存</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://s2.loli.net/2023/07/22/lPKvfF4Jx9Wa2re.jpg" target="_blank"><img class="post-qr-code-img" src="https://s2.loli.net/2023/07/22/lPKvfF4Jx9Wa2re.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://s2.loli.net/2023/07/22/RXHziYCq8BIQ4tO.jpg" target="_blank"><img class="post-qr-code-img" src="https://s2.loli.net/2023/07/22/RXHziYCq8BIQ4tO.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/06/24/Docker/"><img class="prev-cover" src="https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Docker 详细教程</div></div></a></div><div class="next-post pull-right"><a href="/2020/07/13/%E7%90%86%E8%A7%A3DevOps%E6%80%9D%E6%83%B3/"><img class="next-cover" src="https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">理解DevOps思想</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/10/29/redis%20%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8F%8C%E5%86%99%E4%B8%8D%E4%B8%80%E8%87%B4/" title="Redis 缓存数据库双写不一致"><img class="cover" src="https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-29</div><div class="title">Redis 缓存数据库双写不一致</div></div></a></div><div><a href="/2022/03/19/%E8%A7%A3%E5%86%B3%20Redis%20Big%20Key%20%E9%97%AE%E9%A2%98/" title="解决 Redis 的 Big Key 问题"><img class="cover" src="https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-19</div><div class="title">解决 Redis 的 Big Key 问题</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2022/08/27/Xqxt6gBj3eZkYLs.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Mr.Want</div><div class="author-info__description">朱颜辞镜花辞树，最是人间留不住</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zhangjiawang" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:zhangjiawang99@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E6%95%99%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">Redis 教程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nosql-%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">Nosql 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8-Nosql"><span class="toc-number">2.1.</span> <span class="toc-text">为什么要用 Nosql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-NoSQL"><span class="toc-number">2.2.</span> <span class="toc-text">什么是 NoSQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nosql-%E7%9A%84%E5%9B%9B%E5%A4%A7%E5%88%86%E7%B1%BB"><span class="toc-number">2.3.</span> <span class="toc-text">Nosql 的四大分类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E5%85%A5%E9%97%A8"><span class="toc-number">3.</span> <span class="toc-text">Redis 入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.</span> <span class="toc-text">Linux 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">3.3.</span> <span class="toc-text">性能测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">3.4.</span> <span class="toc-text">基础知识</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.</span> <span class="toc-text">五大数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-key"><span class="toc-number">4.1.</span> <span class="toc-text">Redis-key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#String%EF%BC%88%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%89"><span class="toc-number">4.2.</span> <span class="toc-text">String（字符串）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#List"><span class="toc-number">4.3.</span> <span class="toc-text">List</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Set%EF%BC%88%E9%9B%86%E5%90%88%EF%BC%89"><span class="toc-number">4.4.</span> <span class="toc-text">Set（集合）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hash%EF%BC%88%E5%93%88%E5%B8%8C%EF%BC%89"><span class="toc-number">4.5.</span> <span class="toc-text">Hash（哈希）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zset%EF%BC%88%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%EF%BC%89"><span class="toc-number">4.6.</span> <span class="toc-text">Zset（有序集合）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E7%89%B9%E6%AE%8A%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text">三种特殊类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#geospatial-%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE"><span class="toc-number">5.1.</span> <span class="toc-text">geospatial 地理位置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hyperloglog"><span class="toc-number">5.2.</span> <span class="toc-text">hyperloglog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bitmaps"><span class="toc-number">5.3.</span> <span class="toc-text">bitmaps</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">6.</span> <span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#redis-conf-%E8%AF%A6%E8%A7%A3"><span class="toc-number">6.1.</span> <span class="toc-text">redis.conf 详解</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">redis 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RDB%EF%BC%88Redis-DataBase%EF%BC%89"><span class="toc-number">7.1.</span> <span class="toc-text">RDB（Redis DataBase）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOF%EF%BC%88Append-Only-File%EF%BC%89"><span class="toc-number">7.2.</span> <span class="toc-text">AOF（Append Only File）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E8%AE%A2%E9%98%85%E5%8F%91%E5%B8%83"><span class="toc-number">8.</span> <span class="toc-text">Redis 订阅发布</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">9.</span> <span class="toc-text">Redis 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">9.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">9.2.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E"><span class="toc-number">9.3.</span> <span class="toc-text">一主二从</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="toc-number">9.4.</span> <span class="toc-text">哨兵模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E5%92%8C%E9%9B%AA%E5%B4%A9"><span class="toc-number">10.</span> <span class="toc-text">Redis 缓存穿透和雪崩</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">10.1.</span> <span class="toc-text">缓存穿透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-number">10.2.</span> <span class="toc-text">缓存击穿</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-number">10.3.</span> <span class="toc-text">缓存雪崩</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/08/28/ueditor%20%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8A%E4%BC%A0%E6%8E%A5%E5%8F%A3/" title="ueditor 自定义上传接口"><img src="https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ueditor 自定义上传接口"/></a><div class="content"><a class="title" href="/2022/08/28/ueditor%20%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8A%E4%BC%A0%E6%8E%A5%E5%8F%A3/" title="ueditor 自定义上传接口">ueditor 自定义上传接口</a><time datetime="2022-08-27T16:27:13.690Z" title="发表于 2022-08-28 00:27:13">2022-08-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/28/ORDER%20BY%20%E6%8E%92%E5%BA%8F%20IF%20%E5%8F%8A%20IN/" title="ORDER BY 排序 IF 以及 IN"><img src="https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ORDER BY 排序 IF 以及 IN"/></a><div class="content"><a class="title" href="/2022/08/28/ORDER%20BY%20%E6%8E%92%E5%BA%8F%20IF%20%E5%8F%8A%20IN/" title="ORDER BY 排序 IF 以及 IN">ORDER BY 排序 IF 以及 IN</a><time datetime="2022-08-27T16:27:13.631Z" title="发表于 2022-08-28 00:27:13">2022-08-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/14/MySQL%20%E5%8A%A0%E5%AF%86%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" title="MySQL 加密遇到的问题"><img src="https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL 加密遇到的问题"/></a><div class="content"><a class="title" href="/2022/08/14/MySQL%20%E5%8A%A0%E5%AF%86%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" title="MySQL 加密遇到的问题">MySQL 加密遇到的问题</a><time datetime="2022-08-13T17:54:07.000Z" title="发表于 2022-08-14 01:54:07">2022-08-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/19/%E8%A7%A3%E5%86%B3%20Redis%20Big%20Key%20%E9%97%AE%E9%A2%98/" title="解决 Redis 的 Big Key 问题"><img src="https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="解决 Redis 的 Big Key 问题"/></a><div class="content"><a class="title" href="/2022/03/19/%E8%A7%A3%E5%86%B3%20Redis%20Big%20Key%20%E9%97%AE%E9%A2%98/" title="解决 Redis 的 Big Key 问题">解决 Redis 的 Big Key 问题</a><time datetime="2022-03-19T13:15:20.000Z" title="发表于 2022-03-19 21:15:20">2022-03-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/08/Linux%20%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%20Git%20%E8%B4%A6%E5%8F%B7/" title="Linux 配置多个 Git 账号"><img src="https://s2.loli.net/2023/07/22/JEb8n6AkesmRuKd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux 配置多个 Git 账号"/></a><div class="content"><a class="title" href="/2022/02/08/Linux%20%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%20Git%20%E8%B4%A6%E5%8F%B7/" title="Linux 配置多个 Git 账号">Linux 配置多个 Git 账号</a><time datetime="2022-02-08T07:00:00.000Z" title="发表于 2022-02-08 15:00:00">2022-02-08</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2023/07/22/3nvYwupIUWTF2gJ.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023  <i id="heartbeat" class="fa fas fa-heartbeat"></i> Mr.Want</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>